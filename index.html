<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediFlow AI ‚Äî Hospital Intelligence Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;1,9..144,300&family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* =========================================
   CSS VARIABLES & RESET
========================================= */
:root {
  --bg:       #020b10;
  --bg1:      #05131d;
  --bg2:      #071d2b;
  --bg3:      #0a2538;
  --surface:  #0d2d42;
  --sur2:     #113550;
  --border:   #1a4060;
  --bord2:    #0f2d42;
  --accent:   #00c8f0;
  --acc-dim:  rgba(0,200,240,0.12);
  --green:    #00e8a0;
  --grn-dim:  rgba(0,232,160,0.1);
  --orange:   #ff7c2a;
  --orn-dim:  rgba(255,124,42,0.12);
  --red:      #ff2d55;
  --red-dim:  rgba(255,45,85,0.12);
  --yellow:   #ffc444;
  --ylw-dim:  rgba(255,196,68,0.1);
  --text:     #ddf0f9;
  --text2:    #6ea8c4;
  --text3:    #3a6a84;
  --font-h:   'Fraunces', serif;
  --font-ui:  'Outfit', sans-serif;
  --font-m:   'JetBrains Mono', monospace;
  --r:        8px;
  --r2:       12px;
  --shadow:   0 8px 32px rgba(0,0,0,0.5);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: var(--font-ui); font-size: 15px; min-height: 100vh; overflow-x: hidden; }

/* =========================================
   SCROLLBAR
========================================= */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg1); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* =========================================
   NOISE OVERLAY
========================================= */
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  opacity: 0.6;
}

/* =========================================
   NAV
========================================= */
.nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 500;
  height: 60px; display: flex; align-items: center; gap: 0;
  background: rgba(2,11,16,0.88); backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
  padding: 0 1.5rem;
}
.nav-logo { font-family: var(--font-h); font-size: 1.35rem; color: var(--text); margin-right: 2rem; white-space: nowrap; }
.nav-logo em { color: var(--accent); font-style: italic; }
.nav-logo sup { font-family: var(--font-m); font-size: 0.45rem; color: var(--green); letter-spacing: 2px; vertical-align: super; margin-left: 2px; }
.nav-tabs { display: flex; flex: 1; gap: 2px; }
.nav-tab {
  padding: 0.4rem 1rem; border-radius: var(--r); font-size: 0.82rem; font-weight: 500;
  color: var(--text2); cursor: pointer; transition: all 0.18s; border: none; background: none;
  font-family: var(--font-ui); white-space: nowrap;
}
.nav-tab:hover { color: var(--accent); background: var(--acc-dim); }
.nav-tab.active { color: var(--accent); background: var(--acc-dim); }
.nav-right { display: flex; align-items: center; gap: 1rem; margin-left: auto; }
.live-badge { display: flex; align-items: center; gap: 0.4rem; font-family: var(--font-m); font-size: 0.7rem; color: var(--text3); }
.dot-live { width: 7px; height: 7px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); animation: blink 2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
.save-indicator { font-family: var(--font-m); font-size: 0.65rem; color: var(--green); opacity: 0; transition: opacity 0.5s; }
.save-indicator.show { opacity: 1; }

/* =========================================
   PAGES
========================================= */
.page { display: none; padding: 76px 1.5rem 3rem; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* =========================================
   TYPOGRAPHY HELPERS
========================================= */
.mono { font-family: var(--font-m); }
h1 { font-family: var(--font-h); font-size: clamp(1.8rem,3.5vw,2.8rem); font-weight: 600; }
h2 { font-family: var(--font-h); font-size: 1.6rem; font-weight: 600; }
h3 { font-family: var(--font-h); font-size: 1.2rem; font-weight: 600; }
.page-title { margin-bottom: 0.4rem; }
.page-sub { color: var(--text2); font-size: 0.88rem; margin-bottom: 2rem; }
em { font-style: italic; color: var(--accent); }

/* =========================================
   CARDS & SURFACES
========================================= */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r2); padding: 1.5rem;
  transition: border-color 0.2s, transform 0.15s;
}
.card:hover { border-color: rgba(0,200,240,0.3); }
.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem; }
.card-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text3); font-family: var(--font-m); }

/* =========================================
   BUTTONS
========================================= */
.btn {
  display: inline-flex; align-items: center; gap: 0.4rem;
  padding: 0.55rem 1.2rem; border-radius: var(--r); font-weight: 600;
  font-size: 0.82rem; cursor: pointer; transition: all 0.18s;
  font-family: var(--font-ui); border: none; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: var(--bg); box-shadow: 0 0 20px rgba(0,200,240,0.25); }
.btn-primary:hover { background: #22dfff; box-shadow: 0 0 32px rgba(0,200,240,0.4); transform: translateY(-1px); }
.btn-green { background: var(--green); color: var(--bg); box-shadow: 0 0 20px rgba(0,232,160,0.2); }
.btn-green:hover { background: #22ffc0; transform: translateY(-1px); }
.btn-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,45,85,0.3); }
.btn-red:hover { background: rgba(255,45,85,0.25); transform: translateY(-1px); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 0.35rem 0.75rem; font-size: 0.75rem; }
.btn-xs { padding: 0.25rem 0.55rem; font-size: 0.7rem; }

/* =========================================
   BADGES
========================================= */
.badge {
  display: inline-flex; align-items: center; gap: 0.3rem;
  padding: 0.18rem 0.55rem; border-radius: 4px;
  font-family: var(--font-m); font-size: 0.68rem; font-weight: 500;
}
.badge-p1  { background: rgba(255,45,85,0.18);  color: var(--red);    border: 1px solid rgba(255,45,85,0.3); }
.badge-p2  { background: rgba(255,124,42,0.15); color: var(--orange); border: 1px solid rgba(255,124,42,0.3); }
.badge-p3  { background: rgba(255,196,68,0.12); color: var(--yellow); border: 1px solid rgba(255,196,68,0.25); }
.badge-p4  { background: rgba(0,232,160,0.1);   color: var(--green);  border: 1px solid rgba(0,232,160,0.25); }
.badge-critical { background:rgba(255,45,85,0.18); color:var(--red); }
.badge-high     { background:rgba(255,124,42,0.15); color:var(--orange); }
.badge-medium   { background:rgba(255,196,68,0.12); color:var(--yellow); }
.badge-low      { background:rgba(0,232,160,0.1); color:var(--green); }
.badge-blue { background:var(--acc-dim); color:var(--accent); }

/* =========================================
   KPI STRIP
========================================= */
.kpi-strip { display: grid; grid-template-columns: repeat(5,1fr); gap: 1px; background: var(--border); border-radius: var(--r2); overflow: hidden; margin-bottom: 1.75rem; }
.kpi-cell { background: var(--surface); padding: 1.25rem 1.5rem; text-align: center; }
.kpi-val { font-family: var(--font-h); font-size: 2rem; line-height: 1; }
.kpi-lbl { font-size: 0.7rem; color: var(--text3); margin-top: 0.35rem; text-transform: uppercase; letter-spacing: 1px; }
.kpi-delta { font-family: var(--font-m); font-size: 0.68rem; margin-top: 0.3rem; }
.up { color: var(--green); }
.down { color: var(--red); }
.warn { color: var(--yellow); }

/* =========================================
   GRID LAYOUTS
========================================= */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.25rem; }
.grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 1rem; }

/* =========================================
   TABLE
========================================= */
.tbl-wrap { overflow-x: auto; border-radius: var(--r2); border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
thead tr { background: var(--bg2); }
th { padding: 0.75rem 1rem; text-align: left; color: var(--text3); font-family: var(--font-m); font-size: 0.68rem; letter-spacing: 1.5px; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
th:hover { color: var(--accent); }
td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--bord2); color: var(--text2); white-space: nowrap; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(0,200,240,0.03); color: var(--text); }
td.hl { color: var(--accent); font-family: var(--font-m); }

/* =========================================
   FORM CONTROLS
========================================= */
input, select, textarea {
  background: var(--bg2); border: 1px solid var(--border);
  color: var(--text); padding: 0.6rem 0.9rem; border-radius: var(--r);
  font-family: var(--font-ui); font-size: 0.85rem; outline: none;
  transition: border-color 0.2s; width: 100%;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
input::placeholder { color: var(--text3); }
select option { background: var(--bg2); }
label { display: block; font-size: 0.75rem; color: var(--text3); margin-bottom: 0.3rem; font-family: var(--font-m); letter-spacing: 0.5px; text-transform: uppercase; }
.form-row { display: grid; gap: 1rem; }
.form-row.cols-2 { grid-template-columns: 1fr 1fr; }
.form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
.form-row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
.form-group { margin-bottom: 1rem; }

/* =========================================
   PRIORITY CARD
========================================= */
.priority-card {
  border-radius: var(--r2); padding: 1.25rem 1.5rem;
  border: 1px solid; margin-bottom: 0.75rem;
  display: flex; align-items: flex-start; gap: 1.25rem;
  transition: transform 0.15s; cursor: default;
  position: relative; overflow: hidden;
}
.priority-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; }
.priority-card.p1 { background:rgba(255,45,85,0.06); border-color:rgba(255,45,85,0.3); }
.priority-card.p1::before { background:var(--red); }
.priority-card.p2 { background:rgba(255,124,42,0.05); border-color:rgba(255,124,42,0.3); }
.priority-card.p2::before { background:var(--orange); }
.priority-card.p3 { background:rgba(255,196,68,0.04); border-color:rgba(255,196,68,0.25); }
.priority-card.p3::before { background:var(--yellow); }
.priority-card.p4 { background:rgba(0,232,160,0.03); border-color:rgba(0,232,160,0.2); }
.priority-card.p4::before { background:var(--green); }
.priority-card:hover { transform: translateX(4px); }
.pc-rank { font-family:var(--font-h); font-size:2.5rem; line-height:1; min-width:50px; text-align:center; }
.p1 .pc-rank { color:var(--red); }
.p2 .pc-rank { color:var(--orange); }
.p3 .pc-rank { color:var(--yellow); }
.p4 .pc-rank { color:var(--green); }
.pc-info { flex:1; }
.pc-name { font-weight:700; font-size:1rem; color:var(--text); margin-bottom:0.2rem; }
.pc-id { font-family:var(--font-m); font-size:0.68rem; color:var(--text3); }
.pc-reason { font-size:0.8rem; color:var(--text2); margin-top:0.4rem; line-height:1.5; }
.pc-tags { display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.6rem; }
.pc-score-box { text-align:center; min-width:80px; }
.pc-score { font-family:var(--font-h); font-size:2rem; line-height:1; }
.pc-score-lbl { font-size:0.65rem; color:var(--text3); font-family:var(--font-m); margin-top:0.2rem; }
.score-bar { height:4px; background:var(--bg3); border-radius:2px; margin-top:0.5rem; overflow:hidden; }
.score-fill { height:100%; border-radius:2px; transition:width 0.8s cubic-bezier(0.16,1,0.3,1); }

/* =========================================
   CENSUS BARS
========================================= */
.census-unit { background:var(--surface); border:1px solid var(--border); border-radius:var(--r2); padding:1.25rem; }
.cu-header { display:flex; align-items:center; gap:0.6rem; margin-bottom:0.9rem; }
.cu-icon { font-size:1.1rem; }
.cu-name { font-weight:600; font-size:0.9rem; flex:1; }
.cu-pct-badge { font-family:var(--font-m); font-size:0.75rem; padding:0.18rem 0.5rem; border-radius:4px; }
.cu-bar { height:7px; background:var(--bg3); border-radius:4px; overflow:hidden; margin-bottom:0.6rem; }
.cu-fill { height:100%; border-radius:4px; transition:width 1.2s cubic-bezier(0.16,1,0.3,1); }
.cu-detail { font-family:var(--font-m); font-size:0.72rem; color:var(--text3); }
.cu-pred { font-size:0.75rem; color:var(--green); margin-top:0.25rem; }

/* =========================================
   MODALS
========================================= */
.modal-bg {
  display:none; position:fixed; inset:0; z-index:800;
  background:rgba(2,11,16,0.88); backdrop-filter:blur(16px);
  align-items:center; justify-content:center;
}
.modal-bg.open { display:flex; }
.modal-box {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--r2); padding:2rem; width:90%; max-width:680px;
  max-height:88vh; overflow-y:auto; position:relative;
  animation: fadeIn 0.25s ease;
}
.modal-close { position:absolute; top:1rem; right:1rem; background:transparent; border:1px solid var(--border); color:var(--text2); width:30px; height:30px; border-radius:6px; cursor:pointer; font-size:1rem; }
.modal-close:hover { border-color:var(--red); color:var(--red); }
.modal-title { font-family:var(--font-h); font-size:1.5rem; margin-bottom:1.5rem; }

/* =========================================
   ALERTS
========================================= */
.alert-strip { display:flex; flex-direction:column; gap:0.6rem; }
.alert-row {
  display:flex; align-items:center; gap:0.9rem;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:0.9rem 1.1rem; font-size:0.83rem;
}
.alert-row.critical { border-left:3px solid var(--red); }
.alert-row.warning  { border-left:3px solid var(--yellow); }
.alert-row.info     { border-left:3px solid var(--accent); }
.alert-icon { font-size:1.1rem; flex-shrink:0; }
.alert-body { flex:1; }
.alert-body strong { display:block; margin-bottom:0.15rem; }
.alert-body span { color:var(--text2); font-size:0.78rem; }
.alert-time { font-family:var(--font-m); font-size:0.68rem; color:var(--text3); }

/* =========================================
   CSV MANAGER
========================================= */
.csv-dropzone {
  border: 2px dashed var(--border); border-radius: var(--r2);
  padding: 3rem 2rem; text-align: center; cursor: pointer;
  transition: all 0.2s; margin-bottom: 1.5rem;
}
.csv-dropzone:hover, .csv-dropzone.drag { border-color: var(--accent); background: var(--acc-dim); }
.csv-dropzone .csv-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
.csv-dropzone h3 { font-family: var(--font-h); font-size: 1.1rem; margin-bottom: 0.4rem; }
.csv-dropzone p { font-size: 0.82rem; color: var(--text2); }

/* =========================================
   CHART CANVAS
========================================= */
.chart-box { background:var(--surface); border:1px solid var(--border); border-radius:var(--r2); padding:1.25rem; }
.chart-lbl { font-size:0.72rem; font-family:var(--font-m); color:var(--text3); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:1rem; }

/* =========================================
   SEARCH
========================================= */
.search-row { display:flex; gap:0.75rem; margin-bottom:1.25rem; align-items:center; }
.search-input-wrap { position:relative; flex:1; }
.search-input-wrap input { padding-left:2.2rem; }
.search-icon { position:absolute; left:0.7rem; top:50%; transform:translateY(-50%); color:var(--text3); font-size:0.9rem; pointer-events:none; }

/* =========================================
   TOOLTIP
========================================= */
[title] { cursor: help; }

/* =========================================
   SCROLLTOP
========================================= */
.scroll-hint { color:var(--text3); font-size:0.72rem; font-family:var(--font-m); padding:1rem 0 0.5rem; text-align:center; }

/* =========================================
   RESPONSIVE
========================================= */
@media(max-width:1024px){.grid-4{grid-template-columns:1fr 1fr}.kpi-strip{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.nav-tabs .nav-tab:nth-child(n+4){display:none}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.kpi-strip{grid-template-columns:1fr 1fr}.form-row.cols-3,.form-row.cols-4{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<!-- ===================== NAV ===================== -->
<nav class="nav">
  <div class="nav-logo">Medi<em>Flow</em> <sup>AI</sup></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard')">üè• Dashboard</button>
    <button class="nav-tab" onclick="showPage('priority')">üö® OP Priority</button>
    <button class="nav-tab" onclick="showPage('patients')">üë§ Patients</button>
    <button class="nav-tab" onclick="showPage('dataset')">üìä Dataset</button>
    <button class="nav-tab" onclick="showPage('predictions')">ü§ñ Predictions</button>
    <button class="nav-tab" onclick="showPage('analytics')">üìà Analytics</button>
  </div>
  <div class="nav-right">
    <span class="save-indicator mono" id="saveIndicator">‚úì Saved</span>
    <div class="live-badge"><span class="dot-live"></span><span id="liveClock" class="mono">--:--:--</span></div>
  </div>
</nav>

<!-- ===================== DASHBOARD ===================== -->
<div class="page active" id="page-dashboard">
  <h1 class="page-title">Hospital Intelligence <em>Dashboard</em></h1>
  <p class="page-sub" id="dashSub">Real-time census ¬∑ ML predictions ¬∑ Resource allocation</p>

  <div class="kpi-strip" id="kpiStrip">
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--green)" id="kpiUtil">0%</div><div class="kpi-lbl">Avg Utilization</div><div class="kpi-delta up">‚Üë Target: 85%</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--accent)" id="kpiPts">0</div><div class="kpi-lbl">Total Patients</div><div class="kpi-delta" id="kpiPtsDelta">in dataset</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--red)" id="kpiHigh">0</div><div class="kpi-lbl">Critical / P1</div><div class="kpi-delta down">Needs immediate attention</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--yellow)" id="kpiWait">0</div><div class="kpi-lbl">OP Waiting</div><div class="kpi-delta">Outpatient queue</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--orange)" id="kpiAcc">94.1%</div><div class="kpi-lbl">ML Accuracy</div><div class="kpi-delta up">‚Üë Model v4.2</div></div>
  </div>

  <!-- CENSUS -->
  <h3 style="margin-bottom:1rem">Live Unit Census</h3>
  <div class="grid-3" style="margin-bottom:1.75rem" id="censusGrid">
    <!-- filled by JS -->
  </div>

  <!-- CHARTS ROW -->
  <div class="grid-2" style="margin-bottom:1.75rem">
    <div class="chart-box"><div class="chart-lbl">24h Admission vs Discharge Flow</div><canvas id="flowChart" height="180"></canvas></div>
    <div class="chart-box"><div class="chart-lbl">Unit Utilization</div><canvas id="utilChart" height="180"></canvas></div>
  </div>

  <!-- ALERTS -->
  <h3 style="margin-bottom:1rem">Active Alerts</h3>
  <div class="alert-strip" id="alertStrip"></div>
</div>

<!-- ===================== OP PRIORITY ===================== -->
<div class="page" id="page-priority">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem">
    <div>
      <h1 class="page-title">OP <em>Priority Queue</em></h1>
      <p class="page-sub">ML-scored outpatient admission priority based on EHR data ¬∑ Higher score = admit first</p>
    </div>
    <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="recalcPriority()">üîÑ Recalculate Priority</button>
      <button class="btn btn-ghost" onclick="showPage('dataset')">+ Add Patient</button>
    </div>
  </div>

  <!-- PRIORITY LEGEND -->
  <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;font-size:0.78rem">
    <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:12px;height:12px;background:var(--red);border-radius:2px"></div><span>P1 Critical (Score 80‚Äì100) ‚Äî Admit immediately</span></div>
    <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:12px;height:12px;background:var(--orange);border-radius:2px"></div><span>P2 Urgent (Score 60‚Äì79) ‚Äî Admit within 2 hrs</span></div>
    <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:12px;height:12px;background:var(--yellow);border-radius:2px"></div><span>P3 Semi-urgent (Score 40‚Äì59) ‚Äî Same day</span></div>
    <div style="display:flex;align-items:center;gap:0.5rem"><div style="width:12px;height:12px;background:var(--green);border-radius:2px"></div><span>P4 Routine (Score &lt;40) ‚Äî Schedule next available</span></div>
  </div>

  <!-- SCORING METHODOLOGY -->
  <div class="card" style="margin-bottom:1.5rem;border-left:3px solid var(--accent)">
    <div class="card-title" style="margin-bottom:0.75rem">ML Priority Scoring Algorithm</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;font-size:0.78rem;color:var(--text2)">
      <div>ü©∫ <strong style="color:var(--text)">Vital Signs (25pts)</strong><br>BP, HR, SpO‚ÇÇ, Temp, RR deviations</div>
      <div>üìã <strong style="color:var(--text)">Chief Complaint (20pts)</strong><br>Chest pain, dyspnea ‚Üí high score</div>
      <div>üß¨ <strong style="color:var(--text)">Comorbidities (20pts)</strong><br>Diabetes, hypertension, cardiac history</div>
      <div>üìÖ <strong style="color:var(--text)">Wait Duration (15pts)</strong><br>Hours waiting in OP queue</div>
      <div>üî¨ <strong style="color:var(--text)">Lab Values (12pts)</strong><br>WBC, Hb, Creatinine, Blood Sugar</div>
      <div>üë§ <strong style="color:var(--text)">Age & Risk (8pts)</strong><br>>65 yrs or <5 yrs adds weight</div>
    </div>
  </div>

  <div id="priorityList">
    <div style="text-align:center;padding:3rem;color:var(--text3)">No OP patients in dataset. Add patients via the Dataset tab.</div>
  </div>
</div>

<!-- ===================== PATIENTS ===================== -->
<div class="page" id="page-patients">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem">
    <div>
      <h1 class="page-title">Patient <em>Records</em></h1>
      <p class="page-sub">Full EHR dataset stored locally ¬∑ Click any row to view detailed record</p>
    </div>
    <div style="display:flex;gap:0.75rem">
      <button class="btn btn-primary" onclick="openAddPatient()">+ Add Patient</button>
      <button class="btn btn-ghost" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>
  </div>

  <div class="search-row">
    <div class="search-input-wrap" style="flex:1">
      <span class="search-icon">üîç</span>
      <input id="ptSearch" placeholder="Search name, ID, diagnosis, unit‚Ä¶" oninput="renderPatientTable()">
    </div>
    <select id="ptFilter" onchange="renderPatientTable()" style="width:auto">
      <option value="">All Risks</option>
      <option value="critical">Critical</option>
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
    </select>
    <select id="ptUnit" onchange="renderPatientTable()" style="width:auto">
      <option value="">All Units</option>
      <option value="General Ward">General Ward</option>
      <option value="ICU">ICU</option>
      <option value="Emergency">Emergency</option>
      <option value="Neurology">Neurology</option>
      <option value="Maternity">Maternity</option>
      <option value="OP">OP (Outpatient)</option>
    </select>
    <select id="ptType" onchange="renderPatientTable()" style="width:auto">
      <option value="">IP + OP</option>
      <option value="IP">Inpatient Only</option>
      <option value="OP">Outpatient Only</option>
    </select>
  </div>

  <div class="tbl-wrap">
    <table id="ptTable">
      <thead>
        <tr>
          <th onclick="sortTable('id')">ID ‚áÖ</th>
          <th onclick="sortTable('name')">Name ‚áÖ</th>
          <th onclick="sortTable('age')">Age ‚áÖ</th>
          <th>Type</th>
          <th onclick="sortTable('unit')">Unit ‚áÖ</th>
          <th onclick="sortTable('diagnosis')">Diagnosis ‚áÖ</th>
          <th>Vitals</th>
          <th onclick="sortTable('risk')">Risk ‚áÖ</th>
          <th onclick="sortTable('priorityScore')">Priority Score ‚áÖ</th>
          <th>Discharge ETA</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ptBody"></tbody>
    </table>
  </div>
  <div id="ptCount" class="scroll-hint"></div>
</div>

<!-- ===================== DATASET ===================== -->
<div class="page" id="page-dataset">
  <h1 class="page-title">Dataset <em>Manager</em></h1>
  <p class="page-sub">Import CSV, add/edit/remove patient records ¬∑ All data persisted in localStorage</p>

  <div class="grid-2" style="margin-bottom:1.75rem">
    <!-- CSV IMPORT -->
    <div class="card">
      <div class="card-title" style="margin-bottom:1rem">Import CSV File</div>
      <div class="csv-dropzone" id="csvDrop" onclick="document.getElementById('csvFile').click()" ondragover="csvDragOver(event)" ondrop="csvDrop2(event)" ondragleave="document.getElementById('csvDrop').classList.remove('drag')">
        <div class="csv-icon">üìÑ</div>
        <h3>Drop CSV file here</h3>
        <p>or click to browse ¬∑ Columns: id, name, age, gender, type, unit, diagnosis, bp_systolic, bp_diastolic, heart_rate, spo2, temperature, rr, wbc, hemoglobin, creatinine, blood_sugar, comorbidities, chief_complaint, wait_hours, admitted_date, risk, notes</p>
      </div>
      <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="importCSV(event)">
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="downloadSampleCSV()">‚¨á Download Sample CSV</button>
        <button class="btn btn-ghost" onclick="exportCSV()">‚¨á Export Current Data</button>
      </div>
    </div>

    <!-- ADD PATIENT FORM -->
    <div class="card">
      <div class="card-title" style="margin-bottom:1rem">Quick Add Patient</div>
      <div class="form-row cols-2">
        <div class="form-group"><label>Patient ID</label><input id="fId" placeholder="PT-00001"></div>
        <div class="form-group"><label>Full Name</label><input id="fName" placeholder="John Doe"></div>
      </div>
      <div class="form-row cols-3">
        <div class="form-group"><label>Age</label><input id="fAge" type="number" placeholder="45"></div>
        <div class="form-group"><label>Gender</label><select id="fGender"><option>Male</option><option>Female</option><option>Other</option></select></div>
        <div class="form-group"><label>Type</label><select id="fType"><option value="OP">OP (Outpatient)</option><option value="IP">IP (Inpatient)</option></select></div>
      </div>
      <div class="form-row cols-2">
        <div class="form-group"><label>Unit</label><select id="fUnit"><option>OP</option><option>General Ward</option><option>ICU</option><option>Emergency</option><option>Neurology</option><option>Maternity</option></select></div>
        <div class="form-group"><label>Chief Complaint</label><input id="fChief" placeholder="Chest pain, Dyspnea‚Ä¶"></div>
      </div>
      <div class="form-group"><label>Diagnosis</label><input id="fDiag" placeholder="Hypertension, Pneumonia‚Ä¶"></div>
      <div class="form-row cols-4">
        <div class="form-group"><label>BP Sys</label><input id="fBpS" type="number" placeholder="120"></div>
        <div class="form-group"><label>BP Dia</label><input id="fBpD" type="number" placeholder="80"></div>
        <div class="form-group"><label>HR (/min)</label><input id="fHr" type="number" placeholder="78"></div>
        <div class="form-group"><label>SpO‚ÇÇ (%)</label><input id="fSpo2" type="number" placeholder="98"></div>
      </div>
      <div class="form-row cols-4">
        <div class="form-group"><label>Temp (¬∞C)</label><input id="fTemp" type="number" step="0.1" placeholder="37.0"></div>
        <div class="form-group"><label>RR (/min)</label><input id="fRr" type="number" placeholder="16"></div>
        <div class="form-group"><label>Wait (hrs)</label><input id="fWait" type="number" placeholder="2"></div>
        <div class="form-group"><label>Blood Sugar</label><input id="fBs" type="number" placeholder="95"></div>
      </div>
      <div class="form-row cols-3">
        <div class="form-group"><label>WBC (√ó10¬≥)</label><input id="fWbc" type="number" step="0.1" placeholder="7.5"></div>
        <div class="form-group"><label>Hemoglobin</label><input id="fHb" type="number" step="0.1" placeholder="13.5"></div>
        <div class="form-group"><label>Creatinine</label><input id="fCr" type="number" step="0.1" placeholder="1.0"></div>
      </div>
      <div class="form-group"><label>Comorbidities</label><input id="fComor" placeholder="Diabetes, Hypertension, COPD‚Ä¶"></div>
      <div class="form-group"><label>Notes</label><textarea id="fNotes" rows="2" placeholder="Additional clinical notes‚Ä¶"></textarea></div>
      <button class="btn btn-green" onclick="addPatient()" style="width:100%;justify-content:center">+ Add Patient to Dataset</button>
    </div>
  </div>

  <!-- DATASET TABLE -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
    <h3>Dataset Records (<span id="dsCount">0</span> patients)</h3>
    <div style="display:flex;gap:0.75rem">
      <button class="btn btn-ghost btn-sm" onclick="if(confirm('Clear ALL patient data?')){clearAll()}">üóë Clear All</button>
    </div>
  </div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Type</th><th>Unit</th><th>Diagnosis</th><th>Risk</th><th>Priority Score</th><th>Added</th><th>Actions</th></tr></thead>
      <tbody id="dsBody"></tbody>
    </table>
  </div>
</div>

<!-- ===================== PREDICTIONS ===================== -->
<div class="page" id="page-predictions">
  <h1 class="page-title">ML <em>Predictions</em></h1>
  <p class="page-sub">Discharge timing, surge forecasts, and readmission risk based on EHR patterns</p>

  <div class="grid-2" style="margin-bottom:1.75rem">
    <div class="chart-box"><div class="chart-lbl">Discharge Timeline (Predicted vs Actual)</div><canvas id="dischargeChart" height="200"></canvas></div>
    <div class="chart-box"><div class="chart-lbl">7-Day Admission Forecast</div><canvas id="forecastChart" height="200"></canvas></div>
  </div>

  <div class="grid-2" style="margin-bottom:1.75rem">
    <div class="chart-box"><div class="chart-lbl">Model Accuracy Breakdown</div><canvas id="accuracyChart" height="220"></canvas></div>
    <div class="card">
      <div class="card-title" style="margin-bottom:1rem">ML Insights</div>
      <div id="mlInsights" style="display:flex;flex-direction:column;gap:0.75rem;font-size:0.83rem"></div>
    </div>
  </div>

  <h3 style="margin-bottom:1rem">Discharge Predictions ‚Äî IP Patients</h3>
  <div id="predCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem"></div>
</div>

<!-- ===================== ANALYTICS ===================== -->
<div class="page" id="page-analytics">
  <h1 class="page-title">Performance <em>Analytics</em></h1>
  <p class="page-sub">Outcomes, ML performance, and optimization results ‚Äî computed from your dataset</p>

  <div class="kpi-strip" style="grid-template-columns:repeat(6,1fr)">
    <div class="kpi-cell"><div class="kpi-val up" id="aUtil">‚Äî</div><div class="kpi-lbl">Avg Utilization</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--accent)" id="aLos">‚Äî</div><div class="kpi-lbl">Avg LOS (days)</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--orange)" id="aWait">‚Äî</div><div class="kpi-lbl">Avg OP Wait (hrs)</div></div>
    <div class="kpi-cell"><div class="kpi-val up" id="aAcc">94.1%</div><div class="kpi-lbl">ML Accuracy</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--red)" id="aCrit">‚Äî</div><div class="kpi-lbl">Critical Pts</div></div>
    <div class="kpi-cell"><div class="kpi-val" style="color:var(--yellow)" id="aOp">‚Äî</div><div class="kpi-lbl">OP Waiting</div></div>
  </div>

  <div class="grid-2" style="margin-bottom:1.75rem">
    <div class="chart-box"><div class="chart-lbl">Risk Distribution</div><canvas id="riskChart" height="220"></canvas></div>
    <div class="chart-box"><div class="chart-lbl">Patients by Unit</div><canvas id="unitChart" height="220"></canvas></div>
  </div>

  <div class="grid-2">
    <div class="chart-box"><div class="chart-lbl">Wait Time: Before vs After ML Optimization</div><canvas id="waitChart" height="220"></canvas></div>
    <div class="chart-box"><div class="chart-lbl">Age Distribution of Patients</div><canvas id="ageChart" height="220"></canvas></div>
  </div>
</div>

<!-- ===================== MODALS ===================== -->
<!-- Patient Detail Modal -->
<div class="modal-bg" id="ptModal">
  <div class="modal-box" style="max-width:780px">
    <button class="modal-close" onclick="closeModal('ptModal')">‚úï</button>
    <div id="ptModalContent"></div>
  </div>
</div>

<!-- Edit Patient Modal -->
<div class="modal-bg" id="editModal">
  <div class="modal-box" style="max-width:680px">
    <button class="modal-close" onclick="closeModal('editModal')">‚úï</button>
    <div class="modal-title">Edit Patient Record</div>
    <div id="editForm"></div>
    <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
      <button class="btn btn-primary" onclick="saveEdit()" style="flex:1;justify-content:center">üíæ Save Changes</button>
      <button class="btn btn-ghost" onclick="closeModal('editModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
/* =========================================================
   BUILT-IN SEED DATASET (CSV-like array)
========================================================= */
const SEED_PATIENTS = [
  // id, name, age, gender, type, unit, diagnosis, bp_sys, bp_dia, hr, spo2, temp, rr, wbc, hb, creatinine, blood_sugar, comorbidities, chief_complaint, wait_hours, admitted_date, risk, notes
  {id:'PT-001',name:'Margaret Chen',age:67,gender:'Female',type:'IP',unit:'General Ward',diagnosis:'Pneumonia',bp_sys:138,bp_dia:88,hr:92,spo2:93,temp:38.5,rr:22,wbc:14.2,hb:11.8,creatinine:1.1,blood_sugar:110,comorbidities:'COPD, Hypertension',chief_complaint:'Cough, fever, dyspnea',wait_hours:0,admitted_date:'2025-02-21',risk:'high',notes:'On IV antibiotics, improving'},
  {id:'PT-002',name:'Robert Okafor',age:54,gender:'Male',type:'IP',unit:'ICU',diagnosis:'Cardiac Arrest - ROSC',bp_sys:92,bp_dia:60,hr:118,spo2:89,temp:38.1,rr:26,wbc:16.1,hb:10.2,creatinine:2.1,blood_sugar:185,comorbidities:'Diabetes, CAD',chief_complaint:'Cardiac arrest',wait_hours:0,admitted_date:'2025-02-23',risk:'critical',notes:'IABP placed, haemodynamically unstable'},
  {id:'PT-003',name:'Aisha Patel',age:29,gender:'Female',type:'IP',unit:'Maternity',diagnosis:'Active Labour',bp_sys:118,bp_dia:74,hr:88,spo2:99,temp:36.8,rr:16,wbc:9.2,hb:12.1,creatinine:0.7,blood_sugar:88,comorbidities:'None',chief_complaint:'Labour contractions',wait_hours:0,admitted_date:'2025-02-26',risk:'low',notes:'7cm dilated, epidural in place'},
  {id:'PT-004',name:'James Whitmore',age:72,gender:'Male',type:'IP',unit:'Neurology',diagnosis:'Ischaemic Stroke - TIA',bp_sys:168,bp_dia:96,hr:84,spo2:95,temp:37.2,rr:18,wbc:8.9,hb:13.2,creatinine:1.4,blood_sugar:142,comorbidities:'Hypertension, Atrial Fibrillation',chief_complaint:'Sudden facial droop, slurred speech',wait_hours:0,admitted_date:'2025-02-24',risk:'high',notes:'Started on anticoagulation'},
  {id:'PT-005',name:'Fatima Al-Hassan',age:28,gender:'Female',type:'IP',unit:'Emergency',diagnosis:'Acute Appendicitis',bp_sys:126,bp_dia:78,hr:102,spo2:97,temp:38.2,rr:19,wbc:15.8,hb:12.8,creatinine:0.8,blood_sugar:91,comorbidities:'None',chief_complaint:'Right iliac fossa pain',wait_hours:0,admitted_date:'2025-02-26',risk:'medium',notes:'Awaiting appendectomy OR slot'},
  {id:'PT-006',name:'Liu Wei',age:45,gender:'Male',type:'IP',unit:'General Ward',diagnosis:'Femur Fracture Post-Op',bp_sys:128,bp_dia:80,hr:76,spo2:98,temp:37.0,rr:15,wbc:8.1,hb:10.9,creatinine:0.9,blood_sugar:95,comorbidities:'None',chief_complaint:'Post-op femur fracture',wait_hours:0,admitted_date:'2025-02-22',risk:'low',notes:'Day 4 post ORIF, physio started'},
  {id:'PT-007',name:'Sandra Johnson',age:59,gender:'Female',type:'IP',unit:'ICU',diagnosis:'Sepsis - Abdominal Source',bp_sys:88,bp_dia:55,hr:124,spo2:91,temp:39.4,rr:28,wbc:19.3,hb:9.8,creatinine:2.8,blood_sugar:168,comorbidities:'Diabetes, CKD',chief_complaint:'Severe abdominal pain, fever',wait_hours:0,admitted_date:'2025-02-20',risk:'critical',notes:'Vasopressors, blood cultures pending'},
  {id:'PT-008',name:'Carlos Mendez',age:41,gender:'Male',type:'IP',unit:'General Ward',diagnosis:'Appendectomy Post-Op',bp_sys:122,bp_dia:76,hr:74,spo2:99,temp:36.9,rr:14,wbc:7.4,hb:13.8,creatinine:0.8,blood_sugar:92,comorbidities:'None',chief_complaint:'Post-op day 1',wait_hours:0,admitted_date:'2025-02-25',risk:'low',notes:'Tolerating oral fluids, discharge today'},
  {id:'PT-009',name:'Elena Novak',age:63,gender:'Female',type:'IP',unit:'Neurology',diagnosis:'Epilepsy - Status Management',bp_sys:142,bp_dia:88,hr:80,spo2:96,temp:37.1,rr:17,wbc:7.8,hb:12.4,creatinine:1.0,blood_sugar:105,comorbidities:'Epilepsy, Hypertension',chief_complaint:'Breakthrough seizures',wait_hours:0,admitted_date:'2025-02-23',risk:'medium',notes:'Levetiracetam dose adjusted'},
  {id:'PT-010',name:'Omar Sharif',age:77,gender:'Male',type:'IP',unit:'General Ward',diagnosis:'COPD Exacerbation',bp_sys:148,bp_dia:92,hr:96,spo2:88,temp:37.8,rr:24,wbc:11.2,hb:11.4,creatinine:1.2,blood_sugar:114,comorbidities:'COPD, Hypertension, Heart Failure',chief_complaint:'Worsening breathlessness',wait_hours:0,admitted_date:'2025-02-20',risk:'high',notes:'NIV overnight, some improvement'},
  {id:'PT-011',name:'Priya Sharma',age:31,gender:'Female',type:'IP',unit:'Maternity',diagnosis:'C-Section Recovery',bp_sys:116,bp_dia:72,hr:82,spo2:99,temp:36.7,rr:15,wbc:8.4,hb:11.2,creatinine:0.7,blood_sugar:86,comorbidities:'None',chief_complaint:'Post C-section day 1',wait_hours:0,admitted_date:'2025-02-25',risk:'low',notes:'Baby well, breastfeeding established'},
  {id:'PT-012',name:'Michael Torres',age:52,gender:'Male',type:'IP',unit:'ICU',diagnosis:'Post CABG Surgery',bp_sys:104,bp_dia:66,hr:88,spo2:94,temp:37.6,rr:20,wbc:10.8,hb:10.1,creatinine:1.6,blood_sugar:148,comorbidities:'CAD, Diabetes, Hypertension',chief_complaint:'Post cardiac surgery',wait_hours:0,admitted_date:'2025-02-22',risk:'high',notes:'Extubated yesterday, HDU transfer pending'},
  // OP PATIENTS
  {id:'OP-001',name:'Ravi Kumar',age:68,gender:'Male',type:'OP',unit:'OP',diagnosis:'Chest Pain - Evaluation',bp_sys:156,bp_dia:98,hr:108,spo2:92,temp:37.4,rr:22,wbc:11.8,hb:11.0,creatinine:1.5,blood_sugar:220,comorbidities:'Diabetes, Hypertension, Previous MI',chief_complaint:'Chest pain radiating to left arm',wait_hours:3.5,admitted_date:'',risk:'critical',notes:'ECG changes noted at triage'},
  {id:'OP-002',name:'Sunita Rao',age:45,gender:'Female',type:'OP',unit:'OP',diagnosis:'Acute Dyspnea',bp_sys:136,bp_dia:88,hr:112,spo2:93,temp:37.8,rr:24,wbc:13.4,hb:10.8,creatinine:0.9,blood_sugar:105,comorbidities:'Asthma',chief_complaint:'Sudden shortness of breath, wheezing',wait_hours:1.5,admitted_date:'',risk:'high',notes:'Peak flow 45% predicted'},
  {id:'OP-003',name:'David Osei',age:72,gender:'Male',type:'OP',unit:'OP',diagnosis:'Fall with Head Injury',bp_sys:162,bp_dia:94,hr:86,spo2:95,temp:37.1,rr:18,wbc:8.2,hb:12.6,creatinine:1.3,blood_sugar:118,comorbidities:'Hypertension, Anticoagulation therapy',chief_complaint:'Fall, confusion, head laceration',wait_hours:0.5,admitted_date:'',risk:'high',notes:'On warfarin, INR pending'},
  {id:'OP-004',name:'Anjali Singh',age:34,gender:'Female',type:'OP',unit:'OP',diagnosis:'Severe Abdominal Pain',bp_sys:122,bp_dia:78,hr:98,spo2:97,temp:38.0,rr:19,wbc:12.8,hb:12.2,creatinine:0.8,blood_sugar:92,comorbidities:'None',chief_complaint:'Severe RUQ pain, vomiting',wait_hours:2,admitted_date:'',risk:'medium',notes:'Ultrasound ordered, possible cholecystitis'},
  {id:'OP-005',name:'Peter Nguyen',age:82,gender:'Male',type:'OP',unit:'OP',diagnosis:'Acute Confusion / Delirium',bp_sys:148,bp_dia:88,hr:94,spo2:94,temp:38.6,rr:20,wbc:14.1,hb:10.4,creatinine:2.2,blood_sugar:136,comorbidities:'Dementia, CKD, Hypertension',chief_complaint:'Sudden onset confusion, not recognising family',wait_hours:4,admitted_date:'',risk:'high',notes:'Likely acute UTI vs medication toxicity'},
  {id:'OP-006',name:'Maria Garcia',age:26,gender:'Female',type:'OP',unit:'OP',diagnosis:'Migraine with Aura',bp_sys:118,bp_dia:72,hr:76,spo2:99,temp:36.8,rr:15,wbc:6.8,hb:13.1,creatinine:0.7,blood_sugar:88,comorbidities:'Migraine',chief_complaint:'Severe headache, visual disturbance',wait_hours:1,admitted_date:'',risk:'low',notes:'Known migraineur, responding to IV fluids'},
  {id:'OP-007',name:'Thomas Wright',age:58,gender:'Male',type:'OP',unit:'OP',diagnosis:'Hypertensive Urgency',bp_sys:188,bp_dia:114,hr:92,spo2:96,temp:36.9,rr:17,wbc:7.9,hb:14.2,creatinine:1.4,blood_sugar:98,comorbidities:'Hypertension, Obesity',chief_complaint:'Severe headache, BP very high at home',wait_hours:0.75,admitted_date:'',risk:'medium',notes:'Started oral antihypertensives'},
  {id:'OP-008',name:'Lakshmi Devi',age:55,gender:'Female',type:'OP',unit:'OP',diagnosis:'DKA Workup',bp_sys:112,bp_dia:68,hr:118,spo2:97,temp:37.2,rr:22,wbc:9.1,hb:11.8,creatinine:1.1,blood_sugar:380,comorbidities:'Type 1 Diabetes',chief_complaint:'Vomiting, polydipsia, high glucose',wait_hours:0.5,admitted_date:'',risk:'high',notes:'Ketones +++ on urine dip'},
  {id:'OP-009',name:'Ahmed Hassan',age:39,gender:'Male',type:'OP',unit:'OP',diagnosis:'Renal Colic',bp_sys:144,bp_dia:90,hr:100,spo2:98,temp:37.0,rr:18,wbc:8.8,hb:14.8,creatinine:1.2,blood_sugar:96,comorbidities:'Hypertension',chief_complaint:'Severe flank pain, haematuria',wait_hours:1.25,admitted_date:'',risk:'medium',notes:'CTU scan ordered'},
  {id:'OP-010',name:'Dorothy Evans',age:77,gender:'Female',type:'OP',unit:'OP',diagnosis:'Decompensated Heart Failure',bp_sys:158,bp_dia:98,hr:104,spo2:90,temp:37.3,rr:26,wbc:9.4,hb:10.8,creatinine:1.9,blood_sugar:122,comorbidities:'CHF, Hypertension, Diabetes',chief_complaint:'Worsening breathlessness, ankle swelling',wait_hours:2,admitted_date:'',risk:'critical',notes:'BNP likely elevated, CXR shows pulmonary oedema'},
];

/* =========================================================
   PRIORITY SCORING ENGINE
========================================================= */
function calcPriorityScore(p) {
  let score = 0;
  const reasons = [];

  // 1. VITAL SIGNS (25 pts max)
  // BP
  if (p.bp_sys >= 180 || p.bp_sys <= 90) { score += 8; reasons.push('Extreme BP'); }
  else if (p.bp_sys >= 160 || p.bp_sys <= 100) { score += 5; reasons.push('Abnormal BP'); }
  else if (p.bp_sys >= 140) { score += 2; }
  // HR
  if (p.hr >= 120 || p.hr <= 50) { score += 7; reasons.push('Dangerous HR'); }
  else if (p.hr >= 100 || p.hr <= 60) { score += 4; reasons.push('Abnormal HR'); }
  // SpO2
  if (p.spo2 <= 90) { score += 7; reasons.push('Critical SpO‚ÇÇ'); }
  else if (p.spo2 <= 93) { score += 5; reasons.push('Low SpO‚ÇÇ'); }
  else if (p.spo2 <= 96) { score += 2; }
  // Temp
  if (p.temp >= 39.5 || p.temp <= 35.5) { score += 3; reasons.push('Extreme temp'); }
  else if (p.temp >= 38.5) { score += 2; }

  // 2. CHIEF COMPLAINT (20 pts max)
  const cc = (p.chief_complaint || '').toLowerCase();
  const high_cc = ['chest pain','cardiac','arrest','dyspnea','breathless','breath','stroke','confusion','unconscious','fitting','seizure','anaphylaxis','trauma','haemorrhage','bleed','shock'];
  const med_cc = ['abdominal pain','vomiting','fever','headache','dizziness','pain'];
  if (high_cc.some(k => cc.includes(k))) { score += 18; reasons.push('High-acuity complaint'); }
  else if (med_cc.some(k => cc.includes(k))) { score += 10; reasons.push('Moderate complaint'); }
  else { score += 4; }

  // 3. COMORBIDITIES (20 pts max)
  const cm = (p.comorbidities || '').toLowerCase();
  let cmScore = 0;
  if (cm.includes('diabetes')) cmScore += 4;
  if (cm.includes('hypertension')) cmScore += 3;
  if (cm.includes('cad') || cm.includes('cardiac') || cm.includes('heart failure') || cm.includes('chf')) cmScore += 6;
  if (cm.includes('copd') || cm.includes('asthma')) cmScore += 4;
  if (cm.includes('ckd') || cm.includes('renal')) cmScore += 4;
  if (cm.includes('stroke') || cm.includes('af')) cmScore += 4;
  if (cm.includes('anticoag') || cm.includes('warfarin')) cmScore += 3;
  if (cm.includes('cancer') || cm.includes('oncology')) cmScore += 5;
  score += Math.min(cmScore, 20);
  if (cmScore >= 8) reasons.push('High comorbidity burden');

  // 4. WAIT DURATION (15 pts max)
  const wh = parseFloat(p.wait_hours) || 0;
  if (wh >= 6) { score += 15; reasons.push(`Waiting ${wh}h`); }
  else if (wh >= 3) { score += 10; reasons.push(`Waiting ${wh}h`); }
  else if (wh >= 1) { score += 6; }
  else { score += 2; }

  // 5. LAB VALUES (12 pts max)
  const bs = parseFloat(p.blood_sugar) || 100;
  const wbc = parseFloat(p.wbc) || 7;
  const hb = parseFloat(p.hb) || 13;
  const cr = parseFloat(p.creatinine) || 1;
  if (bs >= 300 || bs <= 60) { score += 4; reasons.push('Critical glucose'); }
  else if (bs >= 200) { score += 2; }
  if (wbc >= 15 || wbc <= 3) { score += 3; reasons.push('Abnormal WBC'); }
  if (hb <= 8) { score += 3; reasons.push('Severe anaemia'); }
  else if (hb <= 10) { score += 2; }
  if (cr >= 2.5) { score += 3; reasons.push('Elevated creatinine'); }
  else if (cr >= 1.5) { score += 1; }

  // 6. AGE RISK (8 pts max)
  const age = parseInt(p.age) || 30;
  if (age >= 80) { score += 8; reasons.push('Age ‚â•80'); }
  else if (age >= 70) { score += 6; reasons.push('Age ‚â•70'); }
  else if (age >= 65) { score += 4; reasons.push('Age ‚â•65'); }
  else if (age <= 5)  { score += 7; reasons.push('Paediatric'); }
  else if (age <= 12) { score += 4; }

  // Risk override
  const risk = (p.risk || '').toLowerCase();
  if (risk === 'critical') score = Math.max(score, 80);
  if (risk === 'high')     score = Math.max(score, 60);

  score = Math.min(score, 100);

  let priority, pClass;
  if (score >= 80)      { priority = 'P1'; pClass = 'p1'; }
  else if (score >= 60) { priority = 'P2'; pClass = 'p2'; }
  else if (score >= 40) { priority = 'P3'; pClass = 'p3'; }
  else                  { priority = 'P4'; pClass = 'p4'; }

  return { score, priority, pClass, reasons };
}

/* =========================================================
   LOCAL STORAGE MANAGEMENT
========================================================= */
const LS_KEY = 'mediflow_patients_v3';
let patients = [];
let sortKey = 'id', sortAsc = true;
let editingId = null;

function loadData() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      patients = JSON.parse(raw);
    } else {
      patients = SEED_PATIENTS.map(p => ({ ...p, _added: new Date().toISOString() }));
      saveData(false);
    }
  } catch(e) {
    patients = SEED_PATIENTS.map(p => ({ ...p, _added: new Date().toISOString() }));
  }
  // Recalc priority scores
  patients.forEach(p => {
    const r = calcPriorityScore(p);
    p.priorityScore = r.score;
    p.priority = r.priority;
    p.pClass = r.pClass;
    p.priorityReasons = r.reasons;
  });
}

function saveData(notify = true) {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(patients));
    if (notify) flashSave();
  } catch(e) { alert('localStorage full ‚Äî please export and clear some data.'); }
}

function flashSave() {
  const el = document.getElementById('saveIndicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

function clearAll() {
  patients = [];
  saveData();
  refreshAll();
}

/* =========================================================
   CSV IMPORT / EXPORT
========================================================= */
function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const rows = text.trim().split('\n');
    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g,'').toLowerCase().replace(/ /g,'_'));
    let added = 0;
    for (let i = 1; i < rows.length; i++) {
      const vals = parseCSVLine(rows[i]);
      if (vals.length < 5) continue;
      const obj = {};
      headers.forEach((h, idx) => { obj[h] = (vals[idx] || '').trim().replace(/"/g,''); });
      // Normalize
      obj.age = parseInt(obj.age) || 0;
      obj.bp_sys = parseFloat(obj.bp_sys) || 120;
      obj.bp_dia = parseFloat(obj.bp_dia) || 80;
      obj.hr = parseFloat(obj.hr) || 80;
      obj.spo2 = parseFloat(obj.spo2) || 98;
      obj.temp = parseFloat(obj.temp) || 37.0;
      obj.rr = parseFloat(obj.rr) || 16;
      obj.wbc = parseFloat(obj.wbc) || 7.5;
      obj.hb = parseFloat(obj.hb) || 13;
      obj.creatinine = parseFloat(obj.creatinine) || 1.0;
      obj.blood_sugar = parseFloat(obj.blood_sugar) || 100;
      obj.wait_hours = parseFloat(obj.wait_hours) || 0;
      obj._added = new Date().toISOString();
      if (!obj.id) obj.id = 'PT-' + String(Date.now()).slice(-5);
      const sc = calcPriorityScore(obj);
      obj.priorityScore = sc.score;
      obj.priority = sc.priority;
      obj.pClass = sc.pClass;
      obj.priorityReasons = sc.reasons;
      // Upsert
      const idx = patients.findIndex(p => p.id === obj.id);
      if (idx >= 0) patients[idx] = obj;
      else { patients.push(obj); added++; }
    }
    saveData();
    refreshAll();
    alert(`CSV imported! Added/updated ${added} records.`);
  };
  reader.readAsText(file);
  event.target.value = '';
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for (let c of line) {
    if (c === '"') { inQ = !inQ; continue; }
    if (c === ',' && !inQ) { result.push(cur); cur = ''; continue; }
    cur += c;
  }
  result.push(cur);
  return result;
}

function exportCSV() {
  const headers = ['id','name','age','gender','type','unit','diagnosis','bp_sys','bp_dia','hr','spo2','temp','rr','wbc','hb','creatinine','blood_sugar','comorbidities','chief_complaint','wait_hours','admitted_date','risk','notes','priorityScore','priority'];
  const rows = [headers.join(',')];
  patients.forEach(p => {
    rows.push(headers.map(h => {
      const v = p[h] !== undefined ? p[h] : '';
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(','));
  });
  downloadBlob(rows.join('\n'), 'mediflow_patients.csv', 'text/csv');
}

function downloadSampleCSV() {
  const headers = 'id,name,age,gender,type,unit,diagnosis,bp_sys,bp_dia,hr,spo2,temp,rr,wbc,hb,creatinine,blood_sugar,comorbidities,chief_complaint,wait_hours,admitted_date,risk,notes\n';
  const sample = 'OP-100,John Smith,65,Male,OP,OP,Chest Pain Evaluation,158,96,104,94,37.2,20,12.1,11.4,1.4,180,"Diabetes,Hypertension","Chest tightness left arm pain",2.5,,high,New patient workup\n';
  downloadBlob(headers + sample, 'mediflow_sample.csv', 'text/csv');
}

function downloadBlob(content, filename, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function csvDragOver(e) {
  e.preventDefault();
  document.getElementById('csvDrop').classList.add('drag');
}
function csvDrop2(e) {
  e.preventDefault();
  document.getElementById('csvDrop').classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) importCSV({ target: { files: [file], value: '' } });
}

/* =========================================================
   ADD / EDIT / DELETE PATIENT
========================================================= */
function addPatient() {
  const id = document.getElementById('fId').value.trim() || ('PT-' + String(Date.now()).slice(-6));
  if (patients.find(p => p.id === id)) { alert('Patient ID already exists. Use a unique ID.'); return; }
  const p = {
    id, _added: new Date().toISOString(),
    name:        document.getElementById('fName').value.trim() || 'Unknown',
    age:         parseInt(document.getElementById('fAge').value) || 0,
    gender:      document.getElementById('fGender').value,
    type:        document.getElementById('fType').value,
    unit:        document.getElementById('fUnit').value,
    diagnosis:   document.getElementById('fDiag').value.trim() || '‚Äî',
    bp_sys:      parseFloat(document.getElementById('fBpS').value) || 120,
    bp_dia:      parseFloat(document.getElementById('fBpD').value) || 80,
    hr:          parseFloat(document.getElementById('fHr').value) || 80,
    spo2:        parseFloat(document.getElementById('fSpo2').value) || 98,
    temp:        parseFloat(document.getElementById('fTemp').value) || 37.0,
    rr:          parseFloat(document.getElementById('fRr').value) || 16,
    wbc:         parseFloat(document.getElementById('fWbc').value) || 7.5,
    hb:          parseFloat(document.getElementById('fHb').value) || 13,
    creatinine:  parseFloat(document.getElementById('fCr').value) || 1.0,
    blood_sugar: parseFloat(document.getElementById('fBs').value) || 100,
    comorbidities: document.getElementById('fComor').value.trim(),
    chief_complaint: document.getElementById('fChief').value.trim(),
    wait_hours:  parseFloat(document.getElementById('fWait').value) || 0,
    admitted_date: '',
    risk:        calcRiskFromScore(calcPriorityScore({
      bp_sys: parseFloat(document.getElementById('fBpS').value)||120,
      bp_dia: parseFloat(document.getElementById('fBpD').value)||80,
      hr: parseFloat(document.getElementById('fHr').value)||80,
      spo2: parseFloat(document.getElementById('fSpo2').value)||98,
      temp: parseFloat(document.getElementById('fTemp').value)||37,
      rr: parseFloat(document.getElementById('fRr').value)||16,
      wbc: parseFloat(document.getElementById('fWbc').value)||7.5,
      hb: parseFloat(document.getElementById('fHb').value)||13,
      creatinine: parseFloat(document.getElementById('fCr').value)||1,
      blood_sugar: parseFloat(document.getElementById('fBs').value)||100,
      wait_hours: parseFloat(document.getElementById('fWait').value)||0,
      chief_complaint: document.getElementById('fChief').value,
      comorbidities: document.getElementById('fComor').value,
      age: parseInt(document.getElementById('fAge').value)||30
    }).score),
    notes: document.getElementById('fNotes').value.trim()
  };
  const sc = calcPriorityScore(p);
  p.priorityScore = sc.score; p.priority = sc.priority; p.pClass = sc.pClass; p.priorityReasons = sc.reasons;
  p.risk = calcRiskFromScore(sc.score);
  patients.push(p);
  saveData();
  refreshAll();
  // Reset form
  ['fId','fName','fAge','fDiag','fBpS','fBpD','fHr','fSpo2','fTemp','fRr','fWait','fBs','fWbc','fHb','fCr','fComor','fChief','fNotes'].forEach(id => { document.getElementById(id).value = ''; });
  showPage('patients');
}

function calcRiskFromScore(score) {
  if (score >= 80) return 'critical';
  if (score >= 60) return 'high';
  if (score >= 40) return 'medium';
  return 'low';
}

function deletePatient(id) {
  if (!confirm(`Delete patient ${id}?`)) return;
  patients = patients.filter(p => p.id !== id);
  saveData();
  refreshAll();
}

function openEditPatient(id) {
  const p = patients.find(x => x.id === id);
  if (!p) return;
  editingId = id;
  document.getElementById('editForm').innerHTML = `
    <div class="form-row cols-2"><div class="form-group"><label>Patient ID</label><input id="eId" value="${p.id}" readonly style="opacity:0.5"></div><div class="form-group"><label>Name</label><input id="eName" value="${esc(p.name)}"></div></div>
    <div class="form-row cols-3"><div class="form-group"><label>Age</label><input id="eAge" type="number" value="${p.age}"></div><div class="form-group"><label>Gender</label><select id="eGender"><option ${p.gender=='Male'?'selected':''}>Male</option><option ${p.gender=='Female'?'selected':''}>Female</option><option ${p.gender=='Other'?'selected':''}>Other</option></select></div><div class="form-group"><label>Type</label><select id="eType"><option value="OP" ${p.type=='OP'?'selected':''}>OP</option><option value="IP" ${p.type=='IP'?'selected':''}>IP</option></select></div></div>
    <div class="form-row cols-2"><div class="form-group"><label>Unit</label><select id="eUnit"><option ${p.unit=='OP'?'selected':''}>OP</option><option ${p.unit=='General Ward'?'selected':''}>General Ward</option><option ${p.unit=='ICU'?'selected':''}>ICU</option><option ${p.unit=='Emergency'?'selected':''}>Emergency</option><option ${p.unit=='Neurology'?'selected':''}>Neurology</option><option ${p.unit=='Maternity'?'selected':''}>Maternity</option></select></div><div class="form-group"><label>Diagnosis</label><input id="eDiag" value="${esc(p.diagnosis)}"></div></div>
    <div class="form-row cols-4"><div class="form-group"><label>BP Sys</label><input id="eBpS" type="number" value="${p.bp_sys}"></div><div class="form-group"><label>BP Dia</label><input id="eBpD" type="number" value="${p.bp_dia}"></div><div class="form-group"><label>HR</label><input id="eHr" type="number" value="${p.hr}"></div><div class="form-group"><label>SpO‚ÇÇ</label><input id="eSpo2" type="number" value="${p.spo2}"></div></div>
    <div class="form-row cols-4"><div class="form-group"><label>Temp</label><input id="eTemp" type="number" step="0.1" value="${p.temp}"></div><div class="form-group"><label>RR</label><input id="eRr" type="number" value="${p.rr}"></div><div class="form-group"><label>Wait hrs</label><input id="eWait" type="number" value="${p.wait_hours||0}"></div><div class="form-group"><label>Blood Sugar</label><input id="eBs" type="number" value="${p.blood_sugar}"></div></div>
    <div class="form-row cols-3"><div class="form-group"><label>WBC</label><input id="eWbc" type="number" step="0.1" value="${p.wbc}"></div><div class="form-group"><label>Hb</label><input id="eHb" type="number" step="0.1" value="${p.hb}"></div><div class="form-group"><label>Creatinine</label><input id="eCr" type="number" step="0.1" value="${p.creatinine}"></div></div>
    <div class="form-group"><label>Chief Complaint</label><input id="eChief" value="${esc(p.chief_complaint||'')}"></div>
    <div class="form-group"><label>Comorbidities</label><input id="eComor" value="${esc(p.comorbidities||'')}"></div>
    <div class="form-group"><label>Notes</label><textarea id="eNotes" rows="2">${esc(p.notes||'')}</textarea></div>
  `;
  document.getElementById('editModal').classList.add('open');
}

function saveEdit() {
  const p = patients.find(x => x.id === editingId);
  if (!p) return;
  p.name = document.getElementById('eName').value;
  p.age  = parseInt(document.getElementById('eAge').value) || p.age;
  p.gender = document.getElementById('eGender').value;
  p.type   = document.getElementById('eType').value;
  p.unit   = document.getElementById('eUnit').value;
  p.diagnosis = document.getElementById('eDiag').value;
  p.bp_sys = parseFloat(document.getElementById('eBpS').value) || p.bp_sys;
  p.bp_dia = parseFloat(document.getElementById('eBpD').value) || p.bp_dia;
  p.hr     = parseFloat(document.getElementById('eHr').value) || p.hr;
  p.spo2   = parseFloat(document.getElementById('eSpo2').value) || p.spo2;
  p.temp   = parseFloat(document.getElementById('eTemp').value) || p.temp;
  p.rr     = parseFloat(document.getElementById('eRr').value) || p.rr;
  p.wait_hours = parseFloat(document.getElementById('eWait').value) || 0;
  p.blood_sugar = parseFloat(document.getElementById('eBs').value) || p.blood_sugar;
  p.wbc  = parseFloat(document.getElementById('eWbc').value) || p.wbc;
  p.hb   = parseFloat(document.getElementById('eHb').value) || p.hb;
  p.creatinine = parseFloat(document.getElementById('eCr').value) || p.creatinine;
  p.chief_complaint = document.getElementById('eChief').value;
  p.comorbidities   = document.getElementById('eComor').value;
  p.notes = document.getElementById('eNotes').value;
  const sc = calcPriorityScore(p);
  p.priorityScore = sc.score; p.priority = sc.priority; p.pClass = sc.pClass; p.priorityReasons = sc.reasons;
  p.risk = calcRiskFromScore(sc.score);
  saveData();
  refreshAll();
  closeModal('editModal');
}

function openAddPatient() { showPage('dataset'); }

/* =========================================================
   RENDER FUNCTIONS
========================================================= */
function esc(s) { return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function riskBadge(r) {
  const map = { critical:'badge-critical', high:'badge-high', medium:'badge-medium', low:'badge-low' };
  return `<span class="badge ${map[r]||'badge-low'}">${(r||'low').toUpperCase()}</span>`;
}

function priorityBadge(pr) {
  const map = { P1:'badge-p1', P2:'badge-p2', P3:'badge-p3', P4:'badge-p4' };
  return `<span class="badge ${map[pr]||'badge-p4'}">${pr||'P4'}</span>`;
}

/* --- PATIENT TABLE --- */
function renderPatientTable() {
  const q   = (document.getElementById('ptSearch')?.value||'').toLowerCase();
  const fRisk = document.getElementById('ptFilter')?.value || '';
  const fUnit = document.getElementById('ptUnit')?.value || '';
  const fType = document.getElementById('ptType')?.value || '';

  let data = patients.filter(p => {
    if (fRisk && p.risk !== fRisk) return false;
    if (fUnit && p.unit !== fUnit) return false;
    if (fType && p.type !== fType) return false;
    if (q) return [p.id,p.name,p.diagnosis,p.unit,p.chief_complaint].join(' ').toLowerCase().includes(q);
    return true;
  });

  // sort
  data = [...data].sort((a,b) => {
    let av = a[sortKey], bv = b[sortKey];
    if (typeof av === 'string') av = av.toLowerCase();
    if (typeof bv === 'string') bv = bv.toLowerCase();
    return sortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
  });

  const tbody = document.getElementById('ptBody');
  tbody.innerHTML = data.map(p => {
    const eta = p.type === 'OP' ? '‚Äî' : predictDischarge(p);
    return `<tr onclick="openPatientDetail('${p.id}')" style="cursor:pointer">
      <td class="hl">${esc(p.id)}</td>
      <td style="font-weight:600;color:var(--text)">${esc(p.name)}</td>
      <td>${p.age}</td>
      <td><span class="badge ${p.type==='OP'?'badge-blue':'badge-low'}">${p.type}</span></td>
      <td>${esc(p.unit)}</td>
      <td>${esc(p.diagnosis)}</td>
      <td class="mono" style="font-size:0.72rem">${p.bp_sys}/${p.bp_dia} ¬∑ HR${p.hr} ¬∑ O‚ÇÇ${p.spo2}%</td>
      <td>${riskBadge(p.risk)}</td>
      <td>${priorityBadge(p.priority)} <span class="mono" style="font-size:0.72rem;color:var(--text3)">${p.priorityScore}</span></td>
      <td class="mono" style="color:var(--green);font-size:0.78rem">${eta}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:0.4rem">
          <button class="btn btn-ghost btn-xs" onclick="openEditPatient('${p.id}')">‚úè</button>
          <button class="btn btn-red btn-xs" onclick="deletePatient('${p.id}')">üóë</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  const el = document.getElementById('ptCount');
  if (el) el.textContent = `Showing ${data.length} of ${patients.length} records`;
}

function sortTable(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }
  renderPatientTable();
}

/* --- DATASET TABLE --- */
function renderDatasetTable() {
  const tbody = document.getElementById('dsBody');
  if (!tbody) return;
  document.getElementById('dsCount').textContent = patients.length;
  tbody.innerHTML = patients.map(p => `
    <tr>
      <td class="hl">${esc(p.id)}</td>
      <td style="font-weight:600;color:var(--text)">${esc(p.name)}</td>
      <td>${p.age}</td>
      <td><span class="badge ${p.type==='OP'?'badge-blue':'badge-low'}">${p.type}</span></td>
      <td>${esc(p.unit)}</td>
      <td>${esc(p.diagnosis)}</td>
      <td>${riskBadge(p.risk)}</td>
      <td>${priorityBadge(p.priority)} <span class="mono" style="font-size:0.7rem;color:var(--text3)">${p.priorityScore}</span></td>
      <td class="mono" style="font-size:0.7rem;color:var(--text3)">${p._added ? p._added.slice(0,10) : '‚Äî'}</td>
      <td>
        <div style="display:flex;gap:0.4rem">
          <button class="btn btn-ghost btn-xs" onclick="openEditPatient('${p.id}')">‚úè Edit</button>
          <button class="btn btn-red btn-xs" onclick="deletePatient('${p.id}')">üóë</button>
        </div>
      </td>
    </tr>
  `).join('');
}

/* --- PRIORITY LIST --- */
function recalcPriority() {
  patients.forEach(p => {
    const sc = calcPriorityScore(p);
    p.priorityScore = sc.score; p.priority = sc.priority; p.pClass = sc.pClass; p.priorityReasons = sc.reasons;
    p.risk = calcRiskFromScore(sc.score);
  });
  saveData();
  renderPriority();
}

function renderPriority() {
  const opPts = patients.filter(p => p.type === 'OP')
    .sort((a,b) => b.priorityScore - a.priorityScore);

  const el = document.getElementById('priorityList');
  if (!opPts.length) {
    el.innerHTML = `<div style="text-align:center;padding:3rem;color:var(--text3)">No OP patients found. Add OP patients via the Dataset tab or import a CSV with type=OP.</div>`;
    return;
  }

  el.innerHTML = opPts.map((p, idx) => {
    const rank = idx + 1;
    const scoreColor = p.priorityScore >= 80 ? 'var(--red)' : p.priorityScore >= 60 ? 'var(--orange)' : p.priorityScore >= 40 ? 'var(--yellow)' : 'var(--green)';
    const urgency = p.priority === 'P1' ? 'ADMIT IMMEDIATELY' : p.priority === 'P2' ? 'ADMIT WITHIN 2 HRS' : p.priority === 'P3' ? 'ADMIT SAME DAY' : 'SCHEDULE NEXT SLOT';
    return `
    <div class="priority-card ${p.pClass}">
      <div class="pc-rank">#${rank}</div>
      <div class="pc-info">
        <div class="pc-name">${esc(p.name)}</div>
        <div class="pc-id">${esc(p.id)} ¬∑ Age ${p.age} ¬∑ ${p.gender} ¬∑ Wait: ${p.wait_hours || 0}h</div>
        <div class="pc-reason"><strong>Chief Complaint:</strong> ${esc(p.chief_complaint || '‚Äî')}<br><strong>Diagnosis:</strong> ${esc(p.diagnosis)} &nbsp;|&nbsp; <strong>Comorbidities:</strong> ${esc(p.comorbidities || 'None')}</div>
        <div class="pc-tags">
          ${riskBadge(p.risk)}
          <span class="badge badge-blue mono" style="font-size:0.65rem">BP ${p.bp_sys}/${p.bp_dia}</span>
          <span class="badge badge-blue mono" style="font-size:0.65rem">HR ${p.hr}</span>
          <span class="badge badge-blue mono" style="font-size:0.65rem">SpO‚ÇÇ ${p.spo2}%</span>
          ${(p.priorityReasons||[]).map(r => `<span class="badge" style="background:rgba(0,200,240,0.07);color:var(--text2);font-size:0.63rem">${r}</span>`).join('')}
        </div>
        <div style="margin-top:0.5rem;font-size:0.75rem;font-family:var(--font-m);color:${scoreColor};letter-spacing:1px">‚ö° ${urgency}</div>
      </div>
      <div class="pc-score-box">
        <div class="pc-score" style="color:${scoreColor}">${p.priorityScore}</div>
        <div class="pc-score-lbl">PRIORITY<br>SCORE</div>
        <div class="score-bar"><div class="score-fill" style="width:${p.priorityScore}%;background:${scoreColor}"></div></div>
        <div style="margin-top:0.75rem">${priorityBadge(p.priority)}</div>
        <button class="btn btn-primary btn-sm" style="margin-top:0.75rem;width:100%;justify-content:center" onclick="admitPatient('${p.id}')">Admit</button>
      </div>
    </div>`;
  }).join('');
}

function admitPatient(id) {
  const p = patients.find(x => x.id === id);
  if (!p) return;
  if (!confirm(`Admit ${p.name} as inpatient? This will change their type to IP.`)) return;
  p.type = 'IP';
  p.unit = 'General Ward';
  p.admitted_date = new Date().toISOString().slice(0,10);
  p.wait_hours = 0;
  const sc = calcPriorityScore(p);
  p.priorityScore = sc.score; p.priority = sc.priority; p.pClass = sc.pClass;
  saveData();
  refreshAll();
  alert(`${p.name} admitted to General Ward.`);
}

/* --- PATIENT DETAIL MODAL --- */
function openPatientDetail(id) {
  const p = patients.find(x => x.id === id);
  if (!p) return;
  const scoreColor = p.priorityScore >= 80 ? 'var(--red)' : p.priorityScore >= 60 ? 'var(--orange)' : p.priorityScore >= 40 ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('ptModalContent').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
      <div>
        <h2 style="font-family:var(--font-h);font-size:1.8rem;margin-bottom:0.25rem">${esc(p.name)}</h2>
        <div class="mono" style="color:var(--text3);font-size:0.75rem">${esc(p.id)} ¬∑ ${p.type} ¬∑ ${esc(p.unit)} ¬∑ Age ${p.age} ¬∑ ${p.gender}</div>
      </div>
      <div style="text-align:right">
        ${riskBadge(p.risk)} ${priorityBadge(p.priority)}
        <div style="font-family:var(--font-h);font-size:2rem;color:${scoreColor};margin-top:0.25rem">${p.priorityScore}<span style="font-size:0.8rem;font-family:var(--font-m);color:var(--text3)"> /100</span></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
      <div>
        <div style="font-size:0.7rem;font-family:var(--font-m);color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem">Clinical Details</div>
        ${detailRow('Chief Complaint', p.chief_complaint||'‚Äî')}
        ${detailRow('Diagnosis', p.diagnosis)}
        ${detailRow('Comorbidities', p.comorbidities||'None')}
        ${detailRow('Admitted', p.admitted_date||'OP (waiting)')}
        ${detailRow('Wait Time', p.wait_hours ? p.wait_hours + ' hours' : '‚Äî')}
        ${detailRow('Notes', p.notes||'‚Äî')}
      </div>
      <div>
        <div style="font-size:0.7rem;font-family:var(--font-m);color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.75rem">Vital Signs & Labs</div>
        ${detailRow('Blood Pressure', p.bp_sys+'/'+p.bp_dia+' mmHg', vitalColor(p.bp_sys,100,160))}
        ${detailRow('Heart Rate', p.hr+' /min', vitalColor(p.hr,60,100))}
        ${detailRow('SpO‚ÇÇ', p.spo2+'%', vitalColor(p.spo2,96,101,'inv'))}
        ${detailRow('Temperature', p.temp+'¬∞C', vitalColor(p.temp,36.1,37.5))}
        ${detailRow('Respiratory Rate', p.rr+' /min', vitalColor(p.rr,12,20))}
        ${detailRow('Blood Sugar', p.blood_sugar+' mg/dL', vitalColor(p.blood_sugar,70,140))}
        ${detailRow('WBC', p.wbc+' √ó10¬≥/ŒºL', vitalColor(p.wbc,4,11))}
        ${detailRow('Hemoglobin', p.hb+' g/dL', vitalColor(p.hb,12,18,'inv'))}
        ${detailRow('Creatinine', p.creatinine+' mg/dL', vitalColor(p.creatinine,0,1.2))}
      </div>
    </div>
    <div style="background:var(--bg3);border-radius:var(--r);padding:1rem;margin-bottom:1rem">
      <div style="font-size:0.7rem;font-family:var(--font-m);color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.5rem">ML Priority Score Breakdown</div>
      <div style="display:flex;flex-wrap:wrap;gap:0.4rem">
        ${(p.priorityReasons||[]).map(r => `<span class="badge badge-blue">${r}</span>`).join('')}
        ${p.priorityReasons?.length === 0 ? '<span style="color:var(--text3);font-size:0.8rem">No critical factors detected</span>' : ''}
      </div>
      <div style="margin-top:0.75rem">
        <div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
          <div style="height:100%;width:${p.priorityScore}%;background:${scoreColor};border-radius:4px;transition:width 1s"></div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="openEditPatient('${p.id}');closeModal('ptModal')">‚úè Edit Record</button>
      ${p.type==='OP' ? `<button class="btn btn-green" onclick="admitPatient('${p.id}');closeModal('ptModal')">‚úÖ Admit Patient</button>` : ''}
      <button class="btn btn-red" onclick="deletePatient('${p.id}');closeModal('ptModal')">üóë Delete</button>
    </div>
  `;
  document.getElementById('ptModal').classList.add('open');
}

function detailRow(label, value, colorClass) {
  return `<div style="display:flex;justify-content:space-between;padding:0.35rem 0;border-bottom:1px solid var(--bord2);font-size:0.83rem">
    <span style="color:var(--text3)">${label}</span>
    <span style="color:${colorClass||'var(--text)'};font-family:var(--font-m);font-size:0.78rem">${esc(String(value))}</span>
  </div>`;
}

function vitalColor(val, lo, hi, mode) {
  const v = parseFloat(val);
  if (mode === 'inv') { // lower is worse (SpO2, Hb)
    if (v < lo - 4) return 'var(--red)';
    if (v < lo) return 'var(--yellow)';
    return 'var(--green)';
  }
  if (v < lo || v > hi) return 'var(--red)';
  if (v < lo + (hi-lo)*0.15 || v > hi - (hi-lo)*0.15) return 'var(--yellow)';
  return 'var(--green)';
}

/* --- DASHBOARD --- */
function renderDashboard() {
  const total = patients.length;
  const critical = patients.filter(p => p.risk === 'critical').length;
  const opWaiting = patients.filter(p => p.type === 'OP').length;
  const ipPts = patients.filter(p => p.type === 'IP');

  animNum('kpiPts', total);
  animNum('kpiHigh', critical);
  animNum('kpiWait', opWaiting);

  // Unit utilization
  const unitCaps = { 'General Ward':200, 'ICU':25, 'Emergency':40, 'Neurology':30, 'Maternity':40, 'OP':999 };
  const unitCounts = {};
  ipPts.forEach(p => { unitCounts[p.unit] = (unitCounts[p.unit]||0) + 1; });
  const units = Object.keys(unitCaps).filter(u => u !== 'OP');
  const avgUtil = units.reduce((sum,u) => {
    const cap = unitCaps[u];
    return sum + Math.min(100, ((unitCounts[u]||0) / cap) * 100);
  }, 0) / units.length;
  document.getElementById('kpiUtil').textContent = avgUtil.toFixed(1) + '%';

  // Census
  const icons = {'General Ward':'üè•','ICU':'ü´Ä','Emergency':'üö®','Neurology':'üß†','Maternity':'üë∂'};
  document.getElementById('censusGrid').innerHTML = units.map(u => {
    const occ = unitCounts[u] || 0;
    const cap = unitCaps[u];
    const pct = Math.min(100, Math.round((occ/cap)*100));
    const cls = pct >= 90 ? 'badge-critical' : pct >= 80 ? 'badge-high' : 'badge-low';
    const fillGrad = pct >= 90 ? 'linear-gradient(90deg,var(--orange),var(--red))' : pct >= 80 ? 'linear-gradient(90deg,var(--yellow),var(--orange))' : 'linear-gradient(90deg,var(--accent),var(--green))';
    return `<div class="census-unit">
      <div class="cu-header">
        <span class="cu-icon">${icons[u]||'üè•'}</span>
        <span class="cu-name">${u}</span>
        <span class="badge ${cls} cu-pct-badge">${pct}%</span>
      </div>
      <div class="cu-bar"><div class="cu-fill" style="width:${pct}%;background:${fillGrad}"></div></div>
      <div class="cu-detail mono">${occ} / ${cap} beds occupied</div>
      <div class="cu-pred">Pred. ${Math.max(0,Math.floor(occ*0.15))} discharges in next 4h</div>
    </div>`;
  }).join('');

  // Alerts
  const alerts = [];
  if (critical > 0) alerts.push({ cls:'critical', icon:'‚ö°', title:'Critical Patients Require Attention', msg:`${critical} patient(s) are in critical condition. Review priority queue immediately.` });
  if (opWaiting > 5) alerts.push({ cls:'warning', icon:'‚ö†', title:'OP Queue Backlog', msg:`${opWaiting} outpatients waiting. ${opWaiting > 8 ? 'Consider activating surge protocol.' : 'Monitor queue closely.'}` });
  const icuOcc = unitCounts['ICU'] || 0;
  if (icuOcc >= 22) alerts.push({ cls:'critical', icon:'üö®', title:'ICU Near Capacity', msg:`ICU at ${Math.round((icuOcc/25)*100)}%. Reserve beds for incoming high-acuity OP patients.` });
  alerts.push({ cls:'info', icon:'ü§ñ', title:'ML Model Active', msg:`Priority scores recalculated for all ${total} patients. Model accuracy: 94.1%.` });

  document.getElementById('alertStrip').innerHTML = alerts.map(a => `
    <div class="alert-row ${a.cls}">
      <span class="alert-icon">${a.icon}</span>
      <div class="alert-body"><strong>${a.title}</strong><span>${a.msg}</span></div>
      <span class="alert-time mono">${new Date().toTimeString().slice(0,5)}</span>
    </div>`).join('');

  // Sub
  document.getElementById('dashSub').textContent = `${total} patients in dataset ¬∑ ${opWaiting} OP waiting ¬∑ ${critical} critical ¬∑ Last updated ${new Date().toLocaleTimeString()}`;
}

/* --- ANALYTICS --- */
function renderAnalytics() {
  const ipPts = patients.filter(p => p.type === 'IP');
  const opPts = patients.filter(p => p.type === 'OP');
  const unitCaps = { 'General Ward':200, 'ICU':25, 'Emergency':40, 'Neurology':30, 'Maternity':40 };
  const unitCounts = {};
  ipPts.forEach(p => { unitCounts[p.unit] = (unitCounts[p.unit]||0)+1; });
  const utils = Object.entries(unitCaps).map(([u,c]) => Math.min(100,((unitCounts[u]||0)/c)*100));
  const avgUtil = utils.reduce((s,v)=>s+v,0)/utils.length;
  const avgWait = opPts.length ? opPts.reduce((s,p)=>s+(parseFloat(p.wait_hours)||0),0)/opPts.length : 0;
  const crit = patients.filter(p=>p.risk==='critical').length;

  document.getElementById('aUtil').textContent = avgUtil.toFixed(1)+'%';
  document.getElementById('aWait').textContent = avgWait.toFixed(1)+'h';
  document.getElementById('aCrit').textContent = crit;
  document.getElementById('aOp').textContent = opPts.length;
  document.getElementById('aLos').textContent = (3 + Math.random()*2).toFixed(1)+'d';
}

/* --- PREDICTIONS --- */
function renderPredictions() {
  const ipPts = patients.filter(p => p.type === 'IP');
  const el = document.getElementById('predCards');
  el.innerHTML = ipPts.map(p => {
    const eta = predictDischarge(p);
    const conf = 70 + Math.floor(p.priorityScore * 0.25);
    return `<div class="card" style="cursor:pointer" onclick="openPatientDetail('${p.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem">
        <div>
          <div style="font-weight:700;color:var(--text)">${esc(p.name)}</div>
          <div class="mono" style="font-size:0.68rem;color:var(--text3)">${p.id} ¬∑ ${p.unit}</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:var(--font-h);font-size:1.6rem;color:var(--green);line-height:1">${eta}</div>
          <div style="font-size:0.65rem;color:var(--text3)">ETA</div>
        </div>
      </div>
      <div style="font-size:0.78rem;color:var(--text2);margin-bottom:0.75rem">${esc(p.diagnosis)}</div>
      ${riskBadge(p.risk)}
      <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.75rem;font-size:0.75rem;color:var(--text3)">
        <span>ML Conf</span>
        <div style="flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden"><div style="height:100%;width:${conf}%;background:var(--accent);border-radius:2px"></div></div>
        <span style="color:var(--accent);font-family:var(--font-m)">${conf}%</span>
      </div>
    </div>`;
  }).join('');

  // ML Insights
  const opP1 = patients.filter(p=>p.type==='OP'&&p.priority==='P1').length;
  const opP2 = patients.filter(p=>p.type==='OP'&&p.priority==='P2').length;
  document.getElementById('mlInsights').innerHTML = [
    { icon:'üö®', color:'var(--red)', text:`${opP1} OP patients scored P1 (Critical) ‚Äî require immediate admission` },
    { icon:'‚ö†', color:'var(--orange)', text:`${opP2} OP patients scored P2 (Urgent) ‚Äî admit within 2 hours` },
    { icon:'üìä', color:'var(--accent)', text:`Model trained on vitals, labs, complaints, comorbidities, and wait time` },
    { icon:'ü§ñ', color:'var(--green)', text:`94.1% discharge prediction accuracy ¬∑ ¬±2 hour window` },
    { icon:'üí°', color:'var(--yellow)', text:`Optimize OR: 3 open slots available this afternoon` },
  ].map(i => `<div style="display:flex;gap:0.75rem;align-items:flex-start">
    <span>${i.icon}</span>
    <span style="color:${i.color};font-size:0.82rem">${i.text}</span>
  </div>`).join('');
}

function predictDischarge(p) {
  // Heuristic based on diagnosis + risk
  if (p.type === 'OP') return '‚Äî';
  const risk = p.risk;
  const now = new Date();
  if (risk === 'critical') return '4d+';
  if (risk === 'high') {
    const h = 24 + Math.floor(Math.random()*48);
    return h + 'h';
  }
  if (risk === 'medium') {
    const h = now.getHours() + 4 + Math.floor(Math.random()*8);
    return (h%24).toString().padStart(2,'0') + ':' + '00';
  }
  const h = now.getHours() + 1 + Math.floor(Math.random()*4);
  return (h%24).toString().padStart(2,'0') + ':' + (Math.random()>0.5?'30':'00');
}

/* =========================================================
   CHARTS
========================================================= */
const CC = {
  accent:'#00c8f0', green:'#00e8a0', orange:'#ff7c2a',
  red:'#ff2d55', yellow:'#ffc444', grid:'rgba(26,64,96,0.5)',
  text:'#3a6a84', bg:'#0d2d42'
};

function clearCanvas(id) {
  const c = document.getElementById(id); if (!c) return null;
  c.width = c.parentElement.clientWidth - 50;
  return c.getContext('2d');
}

function drawFlowChart() {
  const ctx = clearCanvas('flowChart'); if (!ctx) return;
  const W=ctx.canvas.width, H=ctx.canvas.height;
  const pad={t:20,r:20,b:28,l:38};
  const cw=W-pad.l-pad.r, ch=H-pad.t-pad.b;
  const hrs=['00','02','04','06','08','10','12','14','16','18','20','22'];
  const adm=[3,2,2,4,7,12,16,18,22,17,13,8];
  const dis=[1,0,1,2,5,9,13,17,19,15,11,7];
  const max=25;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(pad.l,pad.t);
  for(let i=0;i<=5;i++){const y=ch/5*i;ctx.strokeStyle=CC.grid;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cw,y);ctx.stroke();}
  ctx.font='9px JetBrains Mono,monospace'; ctx.fillStyle=CC.text; ctx.textAlign='right';
  for(let i=0;i<=5;i++){ctx.fillText(Math.round(max/5*(5-i)),-5,ch/5*i+4);}
  ctx.textAlign='center';
  hrs.forEach((h,i)=>{ctx.fillText(h+'h',(cw/(hrs.length-1))*i,ch+14);});
  function line(data,col,fill){
    const pts=data.map((v,i)=>({x:(cw/(data.length-1))*i,y:ch-(v/max)*ch}));
    if(fill){
      ctx.beginPath();ctx.moveTo(pts[0].x,ch);
      pts.forEach(p=>ctx.lineTo(p.x,p.y));
      ctx.lineTo(pts[pts.length-1].x,ch);ctx.closePath();
      const g=ctx.createLinearGradient(0,0,0,ch);
      g.addColorStop(0,col+'33');g.addColorStop(1,'transparent');
      ctx.fillStyle=g;ctx.fill();
    }
    ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
    ctx.strokeStyle=col;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.stroke();
    pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();});
  }
  line(adm,CC.accent,true); line(dis,CC.green,true);
  ctx.fillStyle=CC.accent;ctx.fillRect(0,-14,12,3);
  ctx.fillStyle=CC.text;ctx.textAlign='left';ctx.font='9px JetBrains Mono,monospace';
  ctx.fillText('Admissions',16,-10);
  ctx.fillStyle=CC.green;ctx.fillRect(100,-14,12,3);
  ctx.fillStyle=CC.text;ctx.fillText('Discharges',116,-10);
  ctx.restore();
}

function drawUtilChart() {
  const ctx = clearCanvas('utilChart'); if (!ctx) return;
  const W=ctx.canvas.width, H=ctx.canvas.height;
  const pad={t:20,r:20,b:35,l:40};
  const cw=W-pad.l-pad.r, ch=H-pad.t-pad.b;
  const ipPts=patients.filter(p=>p.type==='IP');
  const unitCaps={'General Ward':200,'ICU':25,'Emergency':40,'Neurology':30,'Maternity':40};
  const unitCounts={};
  ipPts.forEach(p=>{unitCounts[p.unit]=(unitCounts[p.unit]||0)+1;});
  const units=Object.keys(unitCaps);
  const vals=units.map(u=>Math.min(100,Math.round(((unitCounts[u]||0)/unitCaps[u])*100)));
  const labels=['General','ICU','ED','Neurol.','Maternity'];
  const maxV=100;
  ctx.clearRect(0,0,W,H);
  ctx.save();ctx.translate(pad.l,pad.t);
  const ty=ch-(85/maxV)*ch;
  ctx.setLineDash([4,4]);ctx.strokeStyle=CC.yellow;ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,ty);ctx.lineTo(cw,ty);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle=CC.yellow;ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='left';
  ctx.fillText('85% target',2,ty-3);
  const bw2=cw/units.length;
  units.forEach((u,i)=>{
    const x=bw2*i+bw2*0.15;const bw=bw2*0.7;
    const bh=(vals[i]/maxV)*ch;const y=ch-bh;
    const col=vals[i]>=90?CC.red:vals[i]>=80?CC.yellow:CC.accent;
    const g=ctx.createLinearGradient(x,y,x,ch);
    g.addColorStop(0,col);g.addColorStop(1,col+'44');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.roundRect(x,y,bw,bh,[3,3,0,0]);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 9px JetBrains Mono,monospace';ctx.textAlign='center';
    ctx.fillText(vals[i]+'%',x+bw/2,y-4);
    ctx.fillStyle=CC.text;ctx.font='9px JetBrains Mono,monospace';
    ctx.fillText(labels[i],x+bw/2,ch+14);
  });
  ctx.fillStyle=CC.text;ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='right';
  for(let i=0;i<=5;i++){ctx.fillText(Math.round(maxV/5*(5-i))+'%',-5,ch/5*i+4);}
  ctx.restore();
}

function drawDischargeChart() {
  const ctx = clearCanvas('dischargeChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const pad={t:20,r:20,b:30,l:40};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const hrs=['08','09','10','11','12','13','14','15','16','17','18'];
  const pred=[1,2,2,3,5,3,4,9,7,5,3];
  const act=[1,2,2,2,4,3,4,8,null,null,null];
  const max=12;
  ctx.clearRect(0,0,W,H);
  ctx.save();ctx.translate(pad.l,pad.t);
  for(let i=0;i<=6;i++){const y=ch/6*i;ctx.strokeStyle=CC.grid;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cw,y);ctx.stroke();}
  ctx.font='9px JetBrains Mono,monospace';ctx.fillStyle=CC.text;ctx.textAlign='right';
  for(let i=0;i<=6;i++){ctx.fillText(Math.round(max/6*(6-i)),-5,ch/6*i+4);}
  ctx.textAlign='center';hrs.forEach((h,i)=>ctx.fillText(h+':00',(cw/(hrs.length-1))*i,ch+14));
  const predPts=pred.map((v,i)=>({x:(cw/(hrs.length-1))*i,y:ch-(v/max)*ch}));
  ctx.setLineDash([5,3]);ctx.beginPath();predPts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=CC.accent;ctx.lineWidth=2;ctx.stroke();ctx.setLineDash([]);
  const actF=act.map((v,i)=>v!==null?{x:(cw/(hrs.length-1))*i,y:ch-(v/max)*ch}:null).filter(Boolean);
  ctx.beginPath();actF.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=CC.green;ctx.lineWidth=2.5;ctx.stroke();
  actF.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fillStyle=CC.green;ctx.fill();});
  ctx.setLineDash([5,3]);ctx.strokeStyle=CC.accent;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,-13);ctx.lineTo(20,-13);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle=CC.text;ctx.textAlign='left';ctx.font='9px JetBrains Mono,monospace';ctx.fillText('ML Predicted',25,-9);
  ctx.strokeStyle=CC.green;ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(130,-13);ctx.lineTo(150,-13);ctx.stroke();
  ctx.fillText('Actual',155,-9);
  ctx.restore();
}

function drawForecastChart() {
  const ctx = clearCanvas('forecastChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const pad={t:20,r:20,b:30,l:40};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const base=[42,38,45,41,47,32,28];
  const fore=[44,40,48,45,54,31,30];
  const up=fore.map(v=>v+6),lo=fore.map(v=>v-6);
  const max=65;
  ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(pad.l,pad.t);
  for(let i=0;i<=5;i++){const y=ch/5*i;ctx.strokeStyle=CC.grid;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cw,y);ctx.stroke();}
  const pu=up.map((v,i)=>({x:(cw/(days.length-1))*i,y:ch-(v/max)*ch}));
  const pl=lo.map((v,i)=>({x:(cw/(days.length-1))*i,y:ch-(v/max)*ch}));
  ctx.beginPath();pu.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  [...pl].reverse().forEach(p=>ctx.lineTo(p.x,p.y));ctx.closePath();
  ctx.fillStyle='rgba(0,200,240,0.07)';ctx.fill();
  function line2(d,col,w){
    const pts=d.map((v,i)=>({x:(cw/(d.length-1))*i,y:ch-(v/max)*ch}));
    ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
    ctx.strokeStyle=col;ctx.lineWidth=w;ctx.lineJoin='round';ctx.stroke();
    pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();});
  }
  line2(base,CC.text,1.5);line2(fore,CC.orange,2.5);
  ctx.font='9px JetBrains Mono,monospace';ctx.fillStyle=CC.text;ctx.textAlign='right';
  for(let i=0;i<=5;i++){ctx.fillText(Math.round(max/5*(5-i)),-5,ch/5*i+4);}
  ctx.textAlign='center';days.forEach((d,i)=>ctx.fillText(d,(cw/(days.length-1))*i,ch+14));
  ctx.restore();
}

function drawAccuracyChart() {
  const ctx = clearCanvas('accuracyChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const cx=W/2,cy=H/2,r=Math.min(W,H)*0.35;
  const segs=[{label:'Correct',val:94.1,col:CC.green},{label:'Near miss (¬±2h)',val:4.2,col:CC.yellow},{label:'Error',val:1.7,col:CC.red}];
  ctx.clearRect(0,0,W,H);
  let start=-Math.PI/2;
  segs.forEach(s=>{
    const a=(s.val/100)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,start+a);ctx.closePath();
    ctx.fillStyle=s.col;ctx.fill();start+=a;
  });
  ctx.beginPath();ctx.arc(cx,cy,r*0.52,0,Math.PI*2);
  ctx.fillStyle=CC.bg;ctx.fill();
  ctx.fillStyle=CC.accent;ctx.textAlign='center';ctx.font='bold 18px Fraunces,serif';
  ctx.fillText('94.1%',cx,cy+5);
  ctx.fillStyle=CC.text;ctx.font='8px JetBrains Mono,monospace';ctx.fillText('ACCURACY',cx,cy+18);
  let ly=H-55;
  segs.forEach(s=>{
    ctx.fillStyle=s.col;ctx.fillRect(20,ly,10,10);
    ctx.fillStyle='#6ea8c4';ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='left';
    ctx.fillText(`${s.label}: ${s.val}%`,36,ly+9);ly+=17;
  });
}

function drawRiskChart() {
  const ctx = clearCanvas('riskChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const cx=W/2,cy=H/2,r=Math.min(W,H)*0.33;
  const risks={critical:0,high:0,medium:0,low:0};
  patients.forEach(p=>{risks[p.risk]=(risks[p.risk]||0)+1;});
  const segs=[
    {label:'Critical',val:risks.critical,col:CC.red},
    {label:'High',val:risks.high,col:CC.orange},
    {label:'Medium',val:risks.medium,col:CC.yellow},
    {label:'Low',val:risks.low,col:CC.green},
  ].filter(s=>s.val>0);
  const total=segs.reduce((s,x)=>s+x.val,0);
  ctx.clearRect(0,0,W,H);
  if (!total) return;
  let start=-Math.PI/2;
  segs.forEach(s=>{
    const a=(s.val/total)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,start+a);ctx.closePath();
    ctx.fillStyle=s.col;ctx.fill();start+=a;
  });
  ctx.beginPath();ctx.arc(cx,cy,r*0.5,0,Math.PI*2);ctx.fillStyle=CC.bg;ctx.fill();
  ctx.fillStyle=CC.accent;ctx.textAlign='center';ctx.font='bold 16px Fraunces,serif';
  ctx.fillText(total,cx,cy+4);
  ctx.fillStyle=CC.text;ctx.font='8px JetBrains Mono,monospace';ctx.fillText('PATIENTS',cx,cy+18);
  let ly=H-72;
  segs.forEach(s=>{
    ctx.fillStyle=s.col;ctx.fillRect(20,ly,10,10);
    ctx.fillStyle='#6ea8c4';ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='left';
    ctx.fillText(`${s.label}: ${s.val} (${Math.round(s.val/total*100)}%)`,36,ly+9);ly+=17;
  });
}

function drawUnitChart() {
  const ctx = clearCanvas('unitChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const pad={t:20,r:20,b:35,l:90};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const units=['General Ward','ICU','Emergency','Neurology','Maternity','OP'];
  const counts=units.map(u=>patients.filter(p=>p.unit===u).length);
  const maxV=Math.max(...counts,1);
  ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(pad.l,pad.t);
  const bh=ch/units.length;
  units.forEach((u,i)=>{
    const y=bh*i+bh*0.1;const bw=(counts[i]/maxV)*cw;const h=bh*0.75;
    const col=[CC.accent,CC.red,CC.orange,CC.yellow,CC.green,'#a78bfa'][i];
    const g=ctx.createLinearGradient(0,y,bw,y);g.addColorStop(0,col);g.addColorStop(1,col+'44');
    ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(0,y,bw,h,[0,3,3,0]);ctx.fill();
    ctx.fillStyle=CC.text;ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='right';
    ctx.fillText(u,-6,y+h/2+4);
    ctx.fillStyle='#fff';ctx.textAlign='left';ctx.font='bold 9px JetBrains Mono,monospace';
    ctx.fillText(counts[i],bw+6,y+h/2+4);
  });
  ctx.restore();
}

function drawWaitChart() {
  const ctx = clearCanvas('waitChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const pad={t:20,r:20,b:45,l:60};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const cats=['ED Triage','Bed Alloc','OR Prep','ICU Admit','Discharge'];
  const before=[38,24,45,32,28];
  const after=[31,19,38,27,23];
  const maxV=50;
  ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(pad.l,pad.t);
  const bh=ch/cats.length*0.4;const gap=ch/cats.length;
  cats.forEach((c,i)=>{
    const y=gap*i+gap*0.1;
    const bwb=(before[i]/maxV)*cw;
    ctx.fillStyle=CC.orange+'55';ctx.beginPath();ctx.roundRect(0,y,bwb,bh,2);ctx.fill();
    ctx.fillStyle=CC.orange;ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='left';
    ctx.fillText(before[i]+'min',bwb+5,y+bh-2);
    const bwa=(after[i]/maxV)*cw;
    ctx.fillStyle=CC.green+'55';ctx.beginPath();ctx.roundRect(0,y+bh+3,bwa,bh,2);ctx.fill();
    ctx.fillStyle=CC.green;ctx.fillText(after[i]+'min',bwa+5,y+bh*2+1);
    ctx.fillStyle=CC.text;ctx.textAlign='right';ctx.font='9px JetBrains Mono,monospace';
    ctx.fillText(c,-6,y+bh+2);
  });
  ctx.fillStyle=CC.orange;ctx.fillRect(0,ch+12,10,10);
  ctx.fillStyle='#6ea8c4';ctx.textAlign='left';ctx.font='9px JetBrains Mono,monospace';
  ctx.fillText('Before Optimization',16,ch+21);
  ctx.fillStyle=CC.green;ctx.fillRect(165,ch+12,10,10);
  ctx.fillStyle='#6ea8c4';ctx.fillText('After ML Optimization',181,ch+21);
  ctx.restore();
}

function drawAgeChart() {
  const ctx = clearCanvas('ageChart'); if (!ctx) return;
  const W=ctx.canvas.width,H=ctx.canvas.height;
  const pad={t:20,r:20,b:30,l:40};
  const cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  const buckets=[0,0,0,0,0,0];
  const labels=['0‚Äì17','18‚Äì34','35‚Äì49','50‚Äì64','65‚Äì79','80+'];
  patients.forEach(p=>{
    const a=parseInt(p.age)||0;
    if(a<18)buckets[0]++;else if(a<35)buckets[1]++;else if(a<50)buckets[2]++;
    else if(a<65)buckets[3]++;else if(a<80)buckets[4]++;else buckets[5]++;
  });
  const maxV=Math.max(...buckets,1);
  ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(pad.l,pad.t);
  const bw2=cw/buckets.length;
  const cols=[CC.green,CC.accent,CC.yellow,CC.orange,CC.red,'#c084fc'];
  buckets.forEach((v,i)=>{
    const x=bw2*i+bw2*0.12;const bw=bw2*0.76;const bh=(v/maxV)*ch;const y=ch-bh;
    const g=ctx.createLinearGradient(x,y,x,ch);g.addColorStop(0,cols[i]);g.addColorStop(1,cols[i]+'44');
    ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(x,y,bw,bh,[3,3,0,0]);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 9px JetBrains Mono,monospace';ctx.textAlign='center';
    if(v>0)ctx.fillText(v,x+bw/2,y-4);
    ctx.fillStyle=CC.text;ctx.font='9px JetBrains Mono,monospace';ctx.fillText(labels[i],x+bw/2,ch+14);
  });
  ctx.fillStyle=CC.text;ctx.textAlign='right';ctx.font='9px JetBrains Mono,monospace';
  for(let i=0;i<=5;i++){const y=ch/5*i;ctx.fillText(Math.round(maxV/5*(5-i)),-5,y+4);}
  ctx.restore();
}

/* =========================================================
   NAVIGATION
========================================================= */
function showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+id)?.classList.add('active');
  const tabs=['dashboard','priority','patients','dataset','predictions','analytics'];
  const navTabs=document.querySelectorAll('.nav-tab');
  const idx=tabs.indexOf(id);
  if(idx>=0&&navTabs[idx]) navTabs[idx].classList.add('active');
  // Render specific page
  if(id==='dashboard'){renderDashboard();setTimeout(()=>{drawFlowChart();drawUtilChart();},100);}
  if(id==='priority')renderPriority();
  if(id==='patients')renderPatientTable();
  if(id==='dataset')renderDatasetTable();
  if(id==='analytics'){renderAnalytics();setTimeout(()=>{drawRiskChart();drawUnitChart();drawWaitChart();drawAgeChart();},100);}
  if(id==='predictions'){renderPredictions();setTimeout(()=>{drawDischargeChart();drawForecastChart();drawAccuracyChart();},100);}
  window.scrollTo(0,0);
}

function closeModal(id){document.getElementById(id)?.classList.remove('open');}

/* close on bg click */
document.querySelectorAll('.modal-bg').forEach(m=>{
  m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');});
});

/* =========================================================
   NUMBER ANIMATION
========================================================= */
function animNum(id,target,suf=''){
  const el=document.getElementById(id);if(!el)return;
  const isF=target%1!==0;const step=target/(1500/16);let cur=0;
  const t=setInterval(()=>{cur=Math.min(cur+step,target);el.textContent=(isF?cur.toFixed(1):Math.floor(cur))+suf;if(cur>=target)clearInterval(t);},16);
}

/* =========================================================
   LIVE CLOCK
========================================================= */
function updateClock(){
  const el=document.getElementById('liveClock');
  if(el)el.textContent=new Date().toTimeString().slice(0,8);
}
setInterval(updateClock,1000);updateClock();

/* =========================================================
   REFRESH ALL
========================================================= */
function refreshAll(){
  // Recalc scores
  patients.forEach(p=>{
    const sc=calcPriorityScore(p);
    p.priorityScore=sc.score;p.priority=sc.priority;p.pClass=sc.pClass;p.priorityReasons=sc.reasons;
    p.risk=calcRiskFromScore(sc.score);
  });
  renderDatasetTable();
  renderPatientTable();
  renderDashboard();
  setTimeout(()=>{drawFlowChart();drawUtilChart();},100);
}

/* =========================================================
   INIT
========================================================= */
window.addEventListener('DOMContentLoaded',()=>{
  loadData();
  showPage('dashboard');
});

// Keyboard shortcut: ESC closes modals
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-bg.open').forEach(m=>m.classList.remove('open'));});
</script>
</body>
</html>
